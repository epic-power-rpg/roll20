<div class="main-content">
  <input class="new-user-control" name="attr_isNewUser" type="hidden" value="" />
  <div class="new-user-creator character-sheet-page">
    <div class="character-sheet-page">
      <div class="title-section">
        <span class="dragon-logo first-dragon-logo"></span>
        <div class="header-content">
          <h1>Welcome to Epic Power</h1>
          <h2>Who do you want to be today?</h2>
        </div>
        <span class="dragon-logo second-dragon-logo"></span>
      </div>
      <div class="character-chooser">
        <input class="new-user-control" name="attr_selected_user_race_option" type="hidden" value="" />
        <div class="race-picker-buttons button-grid">
          <button class="new-race-option" name="act_create_user_pick_human_option" type="action">
            <img src="https://raw.githubusercontent.com/epic-power-rpg/roll20/main/ui/newUser/images/human-female.jpg" alt="Human Female" />
            <img src="https://raw.githubusercontent.com/epic-power-rpg/roll20/main/ui/newUser/images/human-male.jpg" alt="Human Male" />
            <span>Human</span>
          </button>
          <button class="new-race-option" name="act_create_user_pick_elf_option" type="action">
            <img src="https://raw.githubusercontent.com/epic-power-rpg/roll20/main/ui/newUser/images/elf-male.jpg" alt="Elf Male" />
            <img src="https://raw.githubusercontent.com/epic-power-rpg/roll20/main/ui/newUser/images/elf-female-2.jpg" alt="Elf Female" />
            <span>Elf</span>
          </button>
          <button class="new-race-option" name="act_create_user_pick_dwarf_option" type="action">
            <img src="https://raw.githubusercontent.com/epic-power-rpg/roll20/main/ui/newUser/images/dwarf-male.jpg" alt="Dwarf Male" />
            <img src="https://raw.githubusercontent.com/epic-power-rpg/roll20/main/ui/newUser/images/dwarf-female.jpg" alt="Dwarf Female" />
            <span>Dwarf</span>
          </button>
          <button class="new-race-option" name="act_create_user_pick_gnome_option" type="action">
            <img src="https://raw.githubusercontent.com/epic-power-rpg/roll20/main/ui/newUser/images/gnome-male.jpg" alt="Gnome Male" />
            <img src="https://raw.githubusercontent.com/epic-power-rpg/roll20/main/ui/newUser/images/gnome-female.jpg" alt="Gnome Female" />
            <span>Gnome</span>
          </button>
          <button class="new-race-option" name="act_create_user_pick_orc_option" type="action">
            <img src="https://raw.githubusercontent.com/epic-power-rpg/roll20/main/ui/newUser/images/orc-female.jpg" alt="Orc Female" />
            <img src="https://raw.githubusercontent.com/epic-power-rpg/roll20/main/ui/newUser/images/orc-male-2.jpg" alt="Orc Male" />
            <span>Orc</span>
          </button>
          <button class="new-race-option" name="act_create_user_pick_minotaur_option" type="action">
            <img src="https://raw.githubusercontent.com/epic-power-rpg/roll20/main/ui/newUser/images/minotaur-female.jpg" alt="Minotaur Female" />
            <img src="https://raw.githubusercontent.com/epic-power-rpg/roll20/main/ui/newUser/images/minotaur-male.jpg" alt="Minotaur Male" />
            <span>Minotaur</span>
          </button>
          <button class="new-race-option" name="act_create_user_pick_owlin_option" type="action">
            <img src="https://raw.githubusercontent.com/epic-power-rpg/roll20/main/ui/newUser/images/owlin-male.jpg" alt="Owlin Male" />
            <img src="https://raw.githubusercontent.com/epic-power-rpg/roll20/main/ui/newUser/images/owlin-female.jpg" alt="Owlin Female" />
            <span>Owlin</span>
          </button>
          <button class="new-race-option" name="act_create_user_pick_dryad_option" type="action">
            <img src="https://raw.githubusercontent.com/epic-power-rpg/roll20/main/ui/newUser/images/dryad-female.jpg" alt="Dryad Female" />
            <img src="https://raw.githubusercontent.com/epic-power-rpg/roll20/main/ui/newUser/images/dryad-male-2.jpg" alt="Dryad Male" />
            <span>Dryad</span>
          </button>
          <button class="new-race-option" name="act_create_user_pick_other_option" type="action">
            <span>Other</span>
          </button>
        </div>
        <div class="create-user-section">
          <button class="create-new-user-action" name="act_confirm_create_new_user" type="action">Create Character</button>
        </div>
      </div>
    </div>
  </div>
  <div class="existing-user character-sheet-page">
    <!-- Roll section -->

    <div class="roll-section">
      <!--
      This field is monitored by the api script. Whenever it is changed,
      the script chats the contents. This gets around sheetworkers not being
      able to chat directly.
      -->
      <input name="attr_pendingchat" type="hidden" value="" />
      <div class="roll-select-section">
        <input class="save-pending" type="hidden" name="attr_save_pending" value="0" />
        <button class="big-control save-roll" name="act_saveroll" type="action">&darr; &xcirc;</button>
        <div class="save-radio-stack">
          <input class="roll-chosen" type="hidden" name="attr_roll_chosen" value="" />
          <div class="save-radio-row">
            <button class="radio roll-1" type="action" name="act_choose_roll_1"></button>
            <input class="saved-roll" type="hidden" name="attr_saved_roll_1" value="" />
            <button class="radio roll-2" type="action" name="act_choose_roll_2"></button>
            <input class="saved-roll" type="hidden" name="attr_saved_roll_2" value="" />
            <button class="radio roll-3" type="action" name="act_choose_roll_3"></button>
            <input class="saved-roll" type="hidden" name="attr_saved_roll_3" value="" />
          </div>
          <div class="save-radio-row">
            <button class="radio roll-4" type="action" name="act_choose_roll_4"></button>
            <input class="saved-roll" type="hidden" name="attr_saved_roll_4" value="" />
            <button class="radio roll-5" type="action" name="act_choose_roll_5"></button>
            <input class="saved-roll" type="hidden" name="attr_saved_roll_5" value="" />
            <button class="radio roll-6" type="action" name="act_choose_roll_6"></button>
            <input class="saved-roll" type="hidden" name="attr_saved_roll_6" value="" />
          </div>
        </div>
        &emsp;
      </div>
      <div class="roll-description-section">
        <div class="roll-description-line">
          <label for="attr_action_description">Description</label>
          <input class="flexing" id="attr_action_description" name="attr_action_description" type="text" />
          <label for="attr_action_feats">Feat PWR</label>
          <input class="narrowish" id="attr_action_feats" name="attr_action_feats" type="number" value="0" />
          <label for="attr_action_EP">PWR</label>
          <input class="narrowish" id="attr_action_EP" name="attr_action_EP" type="number" value="0" />
          <label for="attr_action_SP">ER</label>
          <input class="narrowish" id="attr_action_SP" name="attr_action_SP" type="number" value="0" />
        </div>
        <div class="roll-description-line">
          <label for="attr_roll_skill">Skill</label>
          <input class="flexing" id="attr_roll_skill" name="attr_roll_skill" type="text" />
          <label for="attr_roll_ability">Ability</label>
          <input class="narrowish" id="attr_roll_ability" name="attr_roll_ability" type="number" value="0" />
          <label>Mods</label>
          <input class="narrowish" id="attr_roll_mod1" name="attr_roll_mod1" type="number" value="0" />
          <input class="narrowish" id="attr_roll_mod2" name="attr_roll_mod2" type="number" value="0" />
          <input class="narrowish" id="attr_roll_mod3" name="attr_roll_mod3" type="number" value="0" />
          <label for="attr_roll_advance_boost">Boost</label>
          <input class="narrowish" id="attr_roll_advance_boost" name="attr_roll_advance_boost" type="number" value="0" />
          <label for="attr_action_roll_EP">PWR</label>
          <input class="narrow" id="attr_action_roll_EP" name="attr_action_roll_EP" value="@{roll_advance_boost}" disabled="true" />
        </div>
      </div>
      &ensp;
      <input class="disable-do-and-roll" name="attr_disable_do_and_roll" type="hidden" value="0" />
      <button class="big-control do-and-roll" name="act_toproll" type="action"></button>
      &ensp;
      <button class="big-control undo" name="act_undotoproll" type="action"></button>
    </div>
    <hr style="margin:1px; border-top: 1px solid gray;" />

    <!-- Top section -->

    <div class="top-section">
      <div class="flex-stack space-between">
        <div class="diceRollSection">
          <div class="attributeRollSection">
            <div class="attributeName">Init</div>
            <div class="attributeField">
              <span name="attr_initiative"></span>
              <span> + </span>
              <input name="attr_initiativemodifier" type="number" value="0" />
            </div>
            <button class="actionRollButton epRoll_initiative" name="act_epRoll_initiative" type="action"></button>
          </div>
        </div>
        <!-- tab buttons -->
        <div class="tab-holder">
          <!--
          This input's value names the currently selected tab.
          its value is used for css selection of its siblings.
          -->
          <input class="tabcontrol" name="attr_chosentab" type="hidden" value="basic" />
          <button class="tab" name="act_overview" type="action">Overview</button>
          <button class="tab" name="act_basic" type="action">Basic</button>
          <button class="tab" name="act_equipment" type="action">Equipment</button>
          <button class="tab" name="act_skills" type="action">Skills</button>
          <button class="tab" name="act_spells" type="action">Spells</button>
          <button class="tab" name="act_notes" type="action">Notes</button>
        </div>
      </div>
      <!-- Movement & DR -->
      <div class="children-separated no-shrink">
        <div>
          <div class="attribute-name wide larger">
            <button class="popoverButton circledButton" name="act_popover_weightPenalties" type="action">?</button>
            <input class="sectioncontrol" name="attr_chosenPopover" type="hidden" value="false" />
            <div class="section weightPenalties popoverContainer">
              <div class="popoverBackdrop">
                <button name="act_popover_weightPenalties" type="action">Close popover</button>
              </div>
              <div class="popover">
                <button class="closePopoverButton" name="act_popover_weightPenalties" type="action">X</button>
                <div class="center wideish bold">Weight Penalties</div>
                <div class="weight-penalty-table flex-stack">
                  <div class="table-header">
                    <div></div>
                    <div>Pen.</div>
                    <div>Wt.</div>
                  </div>
                  <div>
                    <input name="attr_highlight_weight_penalty_1" type="hidden" />
                    <div>-1</div>
                    <span name="attr_penalty_weight_1"></span>
                  </div>
                  <div>
                    <input name="attr_highlight_weight_penalty_2" type="hidden" />
                    <div>-2</div>
                    <span name="attr_penalty_weight_2"></span>
                  </div>
                  <div>
                    <input name="attr_highlight_weight_penalty_3" type="hidden" />
                    <div>-3</div>
                    <span name="attr_penalty_weight_3"></span>
                  </div>
                  <div>
                    <input name="attr_highlight_weight_penalty_4" type="hidden" />
                    <div>-4</div>
                    <span name="attr_penalty_weight_4"></span>
                  </div>
                  <div>
                    <input name="attr_highlight_weight_penalty_5" type="hidden" />
                    <div>-5</div>
                    <span name="attr_penalty_weight_5"></span>
                  </div>
                  <div>
                    <input name="attr_highlight_weight_penalty_6" type="hidden" />
                    <div>-&infin;</div>
                    <span name="attr_penalty_weight_6"></span>
                  </div>
                </div>
              </div>
            </div> Wt. Load
          </div>
          <span class="narrowish center bold larger value" name="attr_equipment_total_weight"></span>
        </div>
        <div>
          <div class="attribute-name wide larger">Wt. Pen.</div>
          <span class="narrowish center bold larger value" name="attr_displayed_weight_penalty"></span>
        </div>
        <div>
          <div class="attribute-name wide larger">Speed</div>
          <span class="narrowish center bold larger value" name="attr_speed"></span>
        </div>
      </div>
      <!-- Defense -->
      <div class="defense-block">
        <div class="defenses epic-table-header-grid">
          <div>Def.</div>
          <div>Armor</div>
          <div class="armor-header epic-tooltip">None<span class="epic-tooltip-text right">Ability without Armor</span>
          </div>
        </div>
        <div class="defenses-table-row bonus-row" data-epic-table-name="defenses">
          <div class="table-label">+bonus</div>
          <input class="center bold larger" name="attr_defense_boost" type="number" value="0" />
        </div>
        <div class="defenses-table-row" data-epic-table-name="defenses">
          <div class="table-label larger">Dodge</div>
          <input name="attr_dodge" type="hidden" />
          <span class="center bold larger" name="attr_current_dodge_with_armor" value="0"></span>
          <span class="center bold larger" name="attr_current_dodge_without_armor" value="0"></span>
        </div>
        <div class="defenses-table-row" data-epic-table-name="defenses">
          <div class="table-label larger">Block</div>
          <input name="attr_block" type="hidden" />
          <span class="center bold larger" name="attr_current_block_with_armor" value="0"></span>
          <span class="center bold larger" name="attr_current_block_without_armor" value="0"></span>
        </div>
        <div class="defenses-table-row parry-row" data-epic-table-name="defenses">
          <div class="table-label larger">Parry</div>
          <span class="center bold larger" name="attr_current_parry_with_armor" type="number" value="0"></span>
          <span class="center bold larger" name="attr_current_parry_without_armor" type="number" value="0"></span>
        </div>
      </div>

      <!-- HP, PWR, ER -->
      <div class="children-separated no-shrink">
        <div>
          <div class="attribute-name biggish">PWR</div>
          <input class="biggish narrower medium center" name="attr_EP_t" type="number" />
          <div class="inline biggish middle">/</div>
          <button class="reset-total" name="act_reset_ep_t" type="action">&#x21E6;</button>
          <span class="biggish narrow" name="attr_EP_t_max"></span>
        </div>
        <div>
          &emsp;&emsp;&emsp;
          <button class="convert-button" name="act_convert_sp" type="action">&nbsp;&#x21EF;</button>
        </div>
        <div>
          <div class="attribute-name biggish">&ensp;&ensp;&ensp;ER</div>
          <input class="biggish narrower medium center" name="attr_SP" type="number" />
          <span>
            <button class="reset-total" name="act_reset_sp" type="action">&#x21E6;</button>
          </span>
          <span class="biggish narrow" name="attr_SP_max" value="0"></span>
        </div>
        <div>
          <div class="attribute-name biggish">HP</div>
          <!-- TODO: Move this to sheet worker, who can do it right. -->
          <input class="biggish medium center" name="attr_HP" type="number" />
          <span>
            <button class="reset-total" name="act_reset_hp" type="action">&#x21E6;</button>
          </span>
          <span class="biggish narrow" name="attr_HP_max" value="16"></span>
        </div>
      </div>
    </div>
    <!-- Each tabbed section -->
    <!--
    This input's value names the currently selected tab.
    its value is used for css selection of its siblings.
    -->
    <input class="sectioncontrol" name="attr_chosentab" type="hidden" value="basic" />
    <!-- Overview section -->
    <div class="overview section overview-tab">
      <div class="tables-container">
        <div class="advantages-and-feats">
          <!-- Advantages -->
          <div class="advantage-overview no-add-or-modify-buttons">
            <div class="advantage epic-table-header-grid">
              <div>Advantage / Disadvantage</div>
            </div>
            <div class="advantage-table" data-epic-table-name="advantage">
              <div class="conditional-something">
                <!-- This input is used by CSS to hide advantage-row-->
                <input class="advantageField" name="attr_advantage_healthy_count" type="hidden" />
                <div class="advantage-row">
                  <div class="advantage-name">Healthy</div>
                  <span class="advantage-value" name="attr_advantage_healthy_count"></span>
                </div>
              </div>
            </div>
            <div class="advantage-table" data-epic-table-name="advantage">
              <div class="conditional-something">
                <!-- This input is used by CSS to hide advantage-row-->
                <input class="advantageField" name="attr_advantage_packmule_count" type="hidden" />
                <div class="advantage-row">
                  <div class="advantage-name">Pack Mule</div>
                  <span class="advantage-value" name="attr_advantage_packmule_count"></span>
                </div>
              </div>
            </div>
            <div class="advantage-table" data-epic-table-name="advantage">
              <div class="conditional-something">
                <!-- This input is used by CSS to hide advantage-row-->
                <input class="advantageField" name="attr_advantage_strongarms_count" type="hidden" />
                <div class="advantage-row">
                  <div class="advantage-name">Strong Arms</div>
                  <span class="advantage-value" name="attr_advantage_strongarms_count"></span>
                </div>
              </div>
            </div>
            <div class="advantage-table" data-epic-table-name="advantage">
              <div class="conditional-something">
                <!-- This input is used by CSS to hide advantage-row-->
                <input class="advantageField" name="attr_advantage_brute_count" type="hidden" />
                <div class="advantage-row">
                  <div class="advantage-name">Brute</div>
                  <span class="advantage-value" name="attr_advantage_brute_count"></span>
                </div>
              </div>
            </div>
            <div class="advantage-table" data-epic-table-name="advantage">
              <div class="conditional-something">
                <!-- This input is used by CSS to hide advantage-row-->
                <input class="advantageField" name="attr_advantage_fast_count" type="hidden" />
                <div class="advantage-row">
                  <div class="advantage-name">Fast</div>
                  <span class="advantage-value" name="attr_advantage_fast_count"></span>
                </div>
              </div>
            </div>
            <div class="advantage-table" data-epic-table-name="advantage">
              <div class="conditional-something">
                <!-- This input is used by CSS to hide advantage-row-->
                <input class="advantageField" name="attr_advantage_athlete_count" type="hidden" />
                <div class="advantage-row">
                  <div class="advantage-name">Natural Athlete</div>
                  <span class="advantage-value" name="attr_advantage_athlete_count"></span>
                </div>
              </div>
            </div>
            <div class="advantage-table" data-epic-table-name="advantage">
              <div class="conditional-something">
                <!-- This input is used by CSS to hide advantage-row-->
                <input class="advantageField" name="attr_advantage_alert_count" type="hidden" />
                <div class="advantage-row">
                  <div class="advantage-name">Alert</div>
                  <span class="advantage-value" name="attr_advantage_alert_count"></span>
                </div>
              </div>
            </div>
            <div class="advantage-table" data-epic-table-name="advantage">
              <div class="conditional-something">
                <!-- This input is used by CSS to hide advantage-row-->
                <input class="advantageField" name="attr_advantage_wary_count" type="hidden" />
                <div class="advantage-row">
                  <div class="advantage-name">Wary</div>
                  <span class="advantage-value" name="attr_advantage_wary_count"></span>
                </div>
              </div>
            </div>
            <div class="advantage-table" data-epic-table-name="advantage">
              <div class="conditional-something">
                <!-- This input is used by CSS to hide advantage-row-->
                <input class="advantageField" name="attr_advantage_attractive_count" type="hidden" />
                <div class="advantage-row">
                  <div class="advantage-name">Attractive</div>
                  <span class="advantage-value" name="attr_advantage_attractive_count"></span>
                </div>
              </div>
            </div>
            <div class="advantage-table" data-epic-table-name="advantage">
              <div class="conditional-something">
                <!-- This input is used by CSS to hide advantage-row-->
                <input class="advantageField" name="attr_advantage_mage_count" type="hidden" />
                <div class="advantage-row">
                  <div class="advantage-name">Mage</div>
                  <span class="advantage-value" name="attr_advantage_mage_count"></span>
                </div>
              </div>
            </div>
            <div class="advantage-table" data-epic-table-name="advantage">
              <div class="conditional-something">
                <!-- This input is used by CSS to hide advantage-row-->
                <input class="advantageField" name="attr_advantage_devout_count" type="hidden" />
                <div class="advantage-row">
                  <div class="advantage-name">Devout</div>
                  <span class="advantage-value" name="attr_advantage_devout_count"></span>
                </div>
              </div>
            </div>
            <fieldset class="repeating_extraadvantage">
              <span class="extraadvantagename extraadvantage-row" name="attr_extraadvantagename"></span>
            </fieldset>
          </div>
          <!-- Feats -->
          <div class="feat-overview no-add-or-modify-buttons">
            <div class="feat epic-table-header-grid">
              <div class="featextraordinaryletter">Extr</div>
              <div class="featname">Epic Feat</div>
            </div>
            <fieldset class="repeating_feat">
              <span class="featextraordinaryletter feat-row" name="attr_featextraordinaryletter"></span>
              <span class="featname feat-row" name="attr_featname"></span>
              <button class="skill-roll addRollSectionFeat" name="act_addrollsectionfeat" type="action">&#8679;</button>
            </fieldset>
          </div>
        </div>
        <!-- Skills -->
        <div class="skills-overview no-add-or-modify-buttons">
          <div class="skills-table epic-table-header-grid">
            <div class="skillname">Skill</div>
            <div class="skillability">Ability</div>
            <div class="skillbase">Mod</div>
          </div>
          <div class="general-dice-rolls" data-epic-table-name="general-dice-rolls">
            <span class="diceRollName">Roll + Mod</span>
            <span class="ability">&nbsp;</span>
            <span class="mod">
              <input name="attr_roll_modifier" type="number" value="0" />
            </span>
            <button class="generalDiceRoll updateRollSectionContent" name="act_updateRollSectionContent_modifier" type="action">&#8679;</button>
          </div>
          <div class="general-dice-rolls" data-epic-table-name="general-dice-rolls">
            <span class="diceRollName">IQ</span>
            <span class="ability" name="attr_IQ"></span>
            <span class="mod">
              <input name="attr_IQModifier" type="number" value="0" />
            </span>
            <button class="generalDiceRoll updateRollSectionContent" name="act_updateRollSectionContent_IQ" type="action">&#8679;</button>
          </div>
          <div class="general-dice-rolls" data-epic-table-name="general-dice-rolls">
            <span class="diceRollName">DX</span>
            <span class="ability" name="attr_DX"></span>
            <span class="mod">
              <input name="attr_DXmodifier" type="number" value="0" />
            </span>
            <button class="generalDiceRoll updateRollSectionContent" name="act_updateRollSectionContent_DX" type="action">&#8679;</button>
          </div>
          <div class="general-dice-rolls" data-epic-table-name="general-dice-rolls">
            <span class="diceRollName">BR</span>
            <span class="ability" name="attr_BR"></span>
            <span class="mod">
              <input name="attr_BRmodifier" type="number" value="0" />
            </span>
            <button class="generalDiceRoll updateRollSectionContent" name="act_updateRollSectionContent_BR" type="action">&#8679;</button>
          </div>
          <fieldset class="repeating_skill">
            <!-- This input is used by CSS to hide disciplines-->
            <input class="isdiscipline" name="attr_skillisdiscipline" type="hidden" />
            <div class="skill-overview-row-container" data-epic-table-name="skills-table">
              <span class="skillname" name="attr_skillname"></span>
              <span class="skillability" name="attr_skillability"></span>
              <input class="skillbase" name="attr_skillmodifier" type="number" />
              <button class="skill-roll updateRollSectionContent" name="act_updaterollsectioncontent" type="action">&#8679;</button>
            </div>
          </fieldset>
        </div>
        <!-- Weapons -->
        <div class="weapons-overview no-add-or-modify-buttons">
          <div class="weapons-table epic-table-header-grid">
            <div class="equipmentname">Weapon</div>
            <div class="equipmentcount">Count</div>
            <div class="equipmentdamage">Damage</div>
            <div class="equipmentrange">Range</div>
          </div>
          <fieldset class="repeating_weapon">
            <div class="weapons-table-row">
              <div class="weapons-overview-row-container" data-epic-table-name="weapons-table">
                <span class="equipmentname" name="attr_weaponname"></span>
                <input class="equipmentcount" name="attr_weaponcount" type="number" value="1" />
                <span class="equipmentdamage" name="attr_weapondamage"></span>
                <span class="equipmentrange" name="attr_weaponrange"></span>
              </div>
              <!-- This input is used by CSS to hide weaponnotes-->
              <input class="attr_weaponnotes" name="attr_weaponnotes" type="hidden" />
              <div class="weapons-overview-row-notes-container" data-epic-table-name="weapons-equipmentnotes-table">
                <span class="equipmentnotes" name="attr_weaponnotes"></span>
              </div>
            </div>
          </fieldset>
        </div>
      </div>
    </div>
    <!-- Basic section-->
    <div class="basic section basic-tab">
      <div class="advantages-and-feats">
        <div class="power-stats-and-avatars">
          <div class="editable-epic-power-stats-table">
            <div class="epic-power-stats">
              <div class="epic-power-stats epic-table-header-grid">
                <div class="epic-power-stats-name-grid">Attr.</div>
                <div class="epic-power-stats-value-grid">Available</div>
                <div class="epic-power-stats-value-grid">Total</div>
              </div>
              <div class="epic-power-stats-table effectiveness" data-epic-table-name="epic-power-stats">
                <div class="epic-power-stats-name-grid">Eff.</div>
                <span>&nbsp;</span>
                <input class="epic-power-stats-value-grid" name="attr_effectiveness" type="hidden" value="0" />
                <span class="epic-power-stats-value-grid" name="attr_effectiveness"></span>
              </div>
              <div class="epic-power-stats-table" data-epic-table-name="epic-power-stats">
                <div class="epic-power-stats-name-grid">EPN</div>
                <span>&nbsp;</span>
                <input class="epic-power-stats-value-grid" name="attr_power" type="number" value="0" />
              </div>
              <div class="epic-power-stats-table" data-epic-table-name="epic-power-stats">
                <div class="epic-power-stats-name-grid">PWR</div>
                <span class="CP center" name="attr_EP_t"></span>
                <input class="epic-power-stats-value-grid" name="attr_EP_t_max" type="number" value="0" />
              </div>
              <div class="epic-power-stats-table" data-epic-table-name="epic-power-stats">
                <div class="epic-power-stats-name-grid bold">ER</div>
                <input class="epic-power-stats-value-grid" name="attr_SP" type="hidden" value="0" />
                <span class="ER center" name="attr_SP"></span>
                <input class="epic-power-stats grid" name="attr_SP_max" type="hidden" value="2" />
                <span class="epic-power-stats-value-grid center" name="attr_SP_max" type="number" value="0"></span>
              </div>
              <div class="epic-power-stats-table" data-epic-table-name="epic-power-stats">
                <div class="epic-power-stats-name-grid CP bold">CP</div>
                <input class="epic-power-stats-value-grid" name="attr_remaining_cp" type="hidden" value="0" />
                <span class="CP center" name="attr_remaining_cp"></span>
                <input class="epic-power-stats-value-grid CP" name="attr_CP" type="number" value="10" />
              </div>
              <div class="epic-power-stats-table" data-epic-table-name="epic-power-stats">
                <div class="epic-power-stats-name-grid FP bold">FP</div>
                <input class="epic-power-stats-value-grid" name="attr_remaining_fp" type="hidden" value="0" />
                <span class="FP center" name="attr_remaining_fp"></span>
                <input class="epic-power-stats grid" name="attr_FP" type="hidden" value="2" />
                <span class="epic-power-stats-value-grid center FP" name="attr_FP" type="number" value="2"></span>
              </div>
            </div>
          </div>
          <div class="character-avatars">
            <img name="attr_character_token" />
          </div>
        </div>
        <div class="character-attributes-and-stats">
          <div class="character-attributes">
            <div class="character-attributes epic-table-header-grid">
              <div class="character-attributes-name-grid">Attr.</div>
              <div class="character-attributes-value-grid">Value</div>
            </div>
            <div class="character-attributes-table" data-epic-table-name="character-attributes">
              <div class="character-attributes-name-grid">Race</div>
              <input class="character-attributes-value-grid" name="attr_race" type="text" />
            </div>
            <div class="character-attributes-table" data-epic-table-name="character-attributes">
              <div class="character-attributes-name-grid">Gender</div>
              <input class="character-attributes-value-grid" name="attr_gender" type="text" />
            </div>
            <div class="character-attributes-table" data-epic-table-name="character-attributes">
              <div class="character-attributes-name-grid">Height</div>
              <input class="character-attributes-value-grid" name="attr_height" type="text" />
            </div>
            <div class="character-attributes-table" data-epic-table-name="character-attributes">
              <div class="character-attributes-name-grid">Weight</div>
              <input class="character-attributes-value-grid" name="attr_weight" type="number" />
            </div>
            <div class="character-attributes-table" data-epic-table-name="character-attributes">
              <div class="character-attributes-name-grid">Age</div>
              <input class="character-attributes-value-grid" name="attr_age" type="number" />
            </div>
            <div class="character-attributes-table" data-epic-table-name="character-attributes">
              <div class="character-attributes-name-grid">IQ</div>
              <input class="character-attributes-value-grid" name="attr_IQ" type="number" value="1" />
            </div>
            <div class="character-attributes-table" data-epic-table-name="character-attributes">
              <div class="character-attributes-name-grid">DX</div>
              <input class="character-attributes-value-grid" name="attr_DX" type="number" value="1" />
            </div>
            <div class="character-attributes-table" data-epic-table-name="character-attributes">
              <div class="character-attributes-name-grid">BR</div>
              <input class="character-attributes-value-grid" name="attr_BR" type="number" value="1" />
            </div>
            <div class="character-attributes-table" data-epic-table-name="character-attributes">
              <div class="character-attributes-name-grid">CP Cost</div>
              <input name="attr_displayed_attribute_CP" type="hidden" value="-2" />
              <span class="character-attributes-value-grid CP" name="attr_displayed_attribute_CP"></span>
            </div>
          </div>
        </div>
        <!-- Advantages and Disadvantages -->
        <div class="advantages">
          <input name="attr_advantage_total_CP" type="hidden" value="0" />
          <div class="advantage epic-table-header-grid">
            <div class="advantage-grid">Advantage</div>
            <div class="count-placeholder-grid"></div>
            <div class="CP-grid">CP</div>
          </div>
          <div class="advantage-table" data-epic-table-name="advantage">
            <div class="advantage-grid">Healthy</div>
            <select class="skillexpertise-grid" name="attr_advantage_healthy_count">
              <option value=" "></option>
              <option value="-1">-1</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
            <span class="CP-grid" name="attr_advantage_healthy_CPdescription"></span>
          </div>
          <div class="advantage-table" data-epic-table-name="advantage">
            <div class="advantage-grid">Pack Mule</div>
            <select class="skillexpertise-grid" name="attr_advantage_packmule_count">
              <option value=" "></option>
              <option value="-1">-1</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
            <span class="CP-grid" name="attr_advantage_packmule_CPdescription"></span>
          </div>
          <div class="advantage-table" data-epic-table-name="advantage">
            <div class="advantage-grid">Strong Arms</div>
            <select class="skillexpertise-grid" name="attr_advantage_strongarms_count">
              <option value=" "></option>
              <option value="-1">-1</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
            <span class="CP-grid" name="attr_advantage_strongarms_CPdescription"></span>
          </div>
          <div class="advantage-table" data-epic-table-name="advantage">
            <div class="advantage-grid">Brute</div>
            <select class="skillexpertise-grid" name="attr_advantage_brute_count">
              <option value=" "></option>
              <option value="-1">-1</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
            <span class="CP-grid" name="attr_advantage_brute_CPdescription"></span>
          </div>
          <div class="advantage-table" data-epic-table-name="advantage">
            <div class="advantage-grid">Fast</div>
            <select class="skillexpertise-grid" name="attr_advantage_fast_count">
              <option value=" "></option>
              <option value="-1">-1</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
            <span class="CP-grid" name="attr_advantage_fast_CPdescription"></span>
          </div>
          <div class="advantage-table" data-epic-table-name="advantage">
            <div class="advantage-grid">Natural Athlete</div>
            <select class="skillexpertise-grid" name="attr_advantage_athlete_count">
              <option value=" "></option>
              <option value="-1">-1</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
            <span class="CP-grid" name="attr_advantage_athlete_CPdescription"></span>
          </div>
          <div class="advantage-table" data-epic-table-name="advantage">
            <div class="advantage-grid">Alert</div>
            <select class="skillexpertise-grid" name="attr_advantage_alert_count">
              <option value=" "></option>
              <option value="-1">-1</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
            <span class="CP-grid" name="attr_advantage_alert_CPdescription"></span>
          </div>
          <div class="advantage-table" data-epic-table-name="advantage">
            <div class="advantage-grid">Wary</div>
            <select class="skillexpertise-grid" name="attr_advantage_wary_count">
              <option value=" "></option>
              <option value="-1">-1</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
            <span class="CP-grid" name="attr_advantage_wary_CPdescription"></span>
          </div>
          <div class="advantage-table" data-epic-table-name="advantage">
            <div class="advantage-grid">Attractive</div>
            <select class="skillexpertise-grid" name="attr_advantage_attractive_count">
              <option value=" "></option>
              <option value="-1">-1</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
            <span class="CP-grid" name="attr_advantage_attractive_CPdescription"></span>
          </div>
          <div class="advantage-table" data-epic-table-name="advantage">
            <div class="advantage-grid">Mage</div>
            <input name="attr_advantage_mage_minus" type="checkbox" value="1" hidden="true" />
            <select class="skillexpertise-grid" name="attr_advantage_mage_count">
              <option value=" "></option>
              <option value="1">1</option>
            </select>
            <span class="CP-grid" name="attr_advantage_mage_CPdescription"></span>
          </div>
          <div class="advantage-table" data-epic-table-name="advantage">
            <div class="advantage-grid">Devout</div>
            <input name="attr_advantage_devout_minus" type="checkbox" value="1" hidden="true" />
            <select class="skillexpertise-grid" name="attr_advantage_devout_count">
              <option value=" "></option>
              <option value="1">1</option>
            </select>
            <span class="CP-grid" name="attr_advantage_devout_CPdescription"></span>
          </div>
          <fieldset class="repeating_extraadvantage">
            <input class="extraadvantagename-grid" name="attr_extraadvantagename" type="text" />
            <input class="extraadvantageCP-grid" name="attr_extraadvantageCP" type="number" />
            <span class="CP-grid extraadvantageCPdescription-grid" name="attr_extraadvantageCPdescription"></span>
          </fieldset>
        </div>
        <!-- Feats -->
        <div class="feats">
          <input name="attr_feat_total_CP" type="hidden" value="0" />
          <input name="attr_feat_total_single_CP" type="hidden" value="0" />
          <div class="feat epic-table-header-grid">
            <div class="featextraordinary-grid">Extr</div>
            <div class="featname-grid">Feat/Special Abilities</div>
            <div class="CP-grid">CP</div>
          </div>
          <fieldset class="repeating_feat">
            <input class="featextraordinary-grid" name="attr_featextraordinary" type="checkbox" value="1" />
            <input class="featname-grid" name="attr_featname" type="text" />
            <input class="CP-grid" name="attr_featCP" value="" type="number" />
          </fieldset>
        </div>
      </div>
    </div>

    <!-- skill section -->
    <div class="skills section epic-skills-tab">
      <div>
        <span class="bold">
          <span>Disciplines &amp; Skills</span>
          <span>&nbsp;</span>
          <span class="epic-fp-and-cp bold">
            <span>Available:</span>
            <span class="FP bold">FP</span>
            <input name="attr_remaining_fp" type="hidden" value="0" />
            <span class="FP" name="attr_remaining_fp"></span>
            <span>&nbsp;</span>
            <span class="CP bold">CP</span>
            <input name="attr_remaining_cp" type="hidden" value="0" />
            <span class="CP" name="attr_remaining_cp"></span>
          </span>
        </span>
      </div>
      <div class="epic-skill-table">
        <input name="attr_skill_total_FP" type="hidden" value="0" />
        <input name="attr_skill_total_CP" type="hidden" value="0" />
        <div class="epic-table-header-grid skill">
          <div class="skilldisciplineinfo-grid">Discipline?</div>
          <div class="skillname-grid">Name</div>
          <div class="skillability-grid">Ability</div>
          <div class="skillFP-grid">
            <input name="attr_remaining_fp" type="hidden" value="0" />
            <span>
              FP
              (<span class="FP" name="attr_remaining_fp"></span>)</span>
          </div>
          <div class="skillCP-grid">
            <input name="attr_remaining_cp" type="hidden" value="0" />
            <span>
              CP
              (<span class="CP" name="attr_remaining_cp"></span>)</span>
          </div>
          <div class="skillexpertise-grid">Exper.</div>
          <div class="skillattribute-grid">Attribute</div>
          <div class="skillbase-grid">Base</div>
        </div>
        <fieldset class="repeating_skill">
          <select class="skilldisciplineinfo" name="attr_skilldisciplineinfo">
            <option value=" "></option>
            <option value="D">D</option>
            <option value="â‡¡">&#x21E1;</option>
          </select>
          <!--
          The next input puts whether we have a discipline into the
          value property, where CSS can see it
          -->
          <input class="isdiscipline-grid" name="attr_skillisdiscipline" type="hidden" />
          <input class="skillname-grid" name="attr_skillname" type="text" />
          <span class="skillability-grid" name="attr_skillability"></span>
          <span class="skillFP-grid center" name="attr_skillFP"></span>
          <span class="skillCP-grid center" name="attr_skillCP"></span>
          <select class="skillexpertise-grid" name="attr_skillexpertise">
            <option value="--">--</option>
            <option value="B">b</option>
            <option value="ST">st</option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
          </select>
          <input name="attr_skilldisciplineexpertise" type="hidden" />
          <select class="skillattribute-grid" name="attr_skillattribute">
            <option value=""> choose</option>
            <option value="IQ">IQ</option>
            <option value="DX">DX</option>
            <option value="IQ+DX">IQ+DX</option>
            <option value="BR">BR</option>
            <option value="BR+DX">BR+DX</option>
          </select>
          <input class="skillbase-grid" name="attr_skillbase" type="number" value="" />
        </fieldset>
      </div>
      <div class="add-base-skills-section">
        <input class="skill-count-control" name="attr_skillCount" type="hidden" value="" />
        <button class="add-base-skills-button" name="act_popover_addBaseSkills" type="action">Add Base Skills</button>
        <input class="sectioncontrol" name="attr_chosenPopover" type="hidden" value="false" />
        <div class="section addBaseSkills popoverContainer">
          <div class="popoverBackdrop">
            <button name="act_popover_addBaseSkills" type="action">Close popover</button>
          </div>
          <div class="popover fixedPlacementPopover">
            <button class="closePopoverButton" name="act_popover_addBaseSkills" type="action">X</button>
            <h2>Add Base Skills</h2>
            <p>This will add skills to your skills tab.</p>
            <p>Are you sure you want to fill in skills? (You can always delete them)</p>
            <button class="approve-add-base-skills-button" name="act_addbaseskills" type="action">Yes, Please Add Base Skills</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Equipment section -->
    <div class="equipment section equipment-tab">
      <div class="cash-and-equipment-summary">
        <div>
          <div class="attribute-name larger inline bold right middle">Cash</div>
          <input class="wide center bold larger value" name="attr_cash" type="number" />
        </div>
        <div>
          <div class="attribute-name larger inline bold right middle">Equip Value</div>
          <span class="center bold larger value middle" name="attr_equipment_total_value"></span>
        </div>
        <div>
          <div class="attribute-name larger inline bold right middle">Equip Weight</div>
          <span class="center bold larger value middle" name="attr_equipment_total_weight"></span>
        </div>
      </div>

      <div class="small-spacer"></div>
      <div class="armor-table">
        <div class="armor-shield-weapons-tables">
          <div class="epic-table-header-grid armor">
            <div class="equipmentname-grid">Armor</div>
            <div class="armordefense-grid">
              <span class="epic-tooltip">Def.
                <div class="epic-tooltip-text right">Amount added to all defenses</div>
              </span>
            </div>
            <div class="equipmentweight-grid">Weight</div>
            <div class="equipmentvalue-grid">Value</div>
            <div class="equipmentnotes-grid">Notes</div>
          </div>
          <div data-epic-table-name="armor">
            <input class="equipmentname-grid" name="attr_armor_name" type="text" />
            <input class="armordefense-grid" name="attr_armor_defense" type="number" />
            <input class="equipmentweight-grid" name="attr_armor_weight" type="text" />
            <input class="equipmentvalue-grid" name="attr_armor_value" type="text" />
            <input class="equipmentnotes-grid" name="attr_armor_notes" type="text" />
          </div>
        </div>

        <div class="spacer"></div>
        <div class="shield-table">
          <div class="epic-table-header-grid shield">
            <div class="equipmentname-grid">Shield</div>
            <div class="armordefense-grid">
              <span class="epic-tooltip">Def.
                <div class="epic-tooltip-text right">Amount added to Block defense</div>
              </span>
            </div>
            <div class="armordefense-grid">Str.</div>
            <div class="equipmentweight-grid">Weight</div>
            <div class="equipmentvalue-grid">Value</div>
            <div class="equipmentnotes-grid">Notes</div>
          </div>
          <div data-epic-table-name="shield">
            <input class="equipmentname-grid" name="attr_shield_name" type="text" />
            <input class="armordefense-grid" name="attr_shield_defense" type="number" />
            <input class="armordefense-grid" name="attr_shield_stopping_strength" type="number" />
            <input class="equipmentweight-grid" name="attr_shield_weight" type="text" />
            <input class="equipmentvalue-grid" name="attr_shield_value" type="text" />
            <input class="equipmentnotes-grid" name="attr_shield_notes" type="text" />
          </div>
        </div>
        <div class="spacer"></div>
        <div class="weapons-table">
          <input name="attr_weapon_total_weight" type="hidden" value="0" />
          <input name="attr_weapon_total_value" type="hidden" value="0" />
          <div class="epic-table-header-grid weapon">
            <div class="equipmentname-grid">Weapon</div>
            <div class="equipmentdamage-grid">Damage</div>
            <div class="equipmentrange-grid">Range</div>
            <div class="equipmentdefense-grid">
              <span class="epic-tooltip">Def.
                <div class="epic-tooltip-text right">Amount added to Parry defense</div>
              </span>
            </div>
            <div class="equipmentcount-grid">Count</div>
            <div class="equipmentweight-grid">Weight Each</div>
            <div class="equipmentvalue-grid">Value Each</div>
            <div class="equipmentnotes-grid">Notes</div>
          </div>
          <fieldset class="repeating_weapon">
            <input class="equipmentname-grid" name="attr_weaponname" type="text" />
            <input class="equipmentdamage-grid" name="attr_weapondamage" type="text" />
            <input class="equipmentrange-grid" name="attr_weaponrange" type="number" />
            <input class="equipmentdefense-grid" name="attr_weapondefense" type="number" />
            <input class="equipmentcount-grid" name="attr_weaponcount" type="number" value="1" />
            <input class="equipmentweight-grid" name="attr_weaponweight" type="text" />
            <input class="equipmentvalue-grid" name="attr_weaponvalue" type="text" />
            <input class="equipmentnotes-grid" name="attr_weaponnotes" type="text" />
          </fieldset>
        </div>
        <div class="spacer"></div>
        <div class="items-table">
          <input name="attr_item_total_weight" type="hidden" value="0" />
          <input name="attr_item_total_value" type="hidden" value="0" />
          <div class="epic-table-header-grid item">
            <div class="equipmentname-grid">Item</div>
            <div class="equipmentcount-grid">Count</div>
            <div class="equipmentweight-grid">Weight Each</div>
            <div class="equipmentvalue-grid">Value Each</div>
            <div class="equipmentnotes-grid">Notes</div>
          </div>
          <fieldset class="repeating_item">
            <input class="equipmentname-grid" name="attr_itemname" type="text" />
            <input class="equipmentcount-grid" name="attr_itemcount" type="number" value="1" />
            <input class="equipmentweight-grid" name="attr_itemweight" type="text" />
            <input class="equipmentvalue-grid" name="attr_itemvalue" type="text" />
            <input class="equipmentnotes-grid" name="attr_itemnotes" type="text" />
          </fieldset>
        </div>
      </div>
    </div>

    <!-- Spells section -->
    <div class="spells section">
      <!--
      This input's value names the currently selected tab.
      its value is used for css selection of the tab content.
      -->
      <input class="sectioncontrol" name="attr_chosenspelltype" type="hidden" value="arcane" />
      <!-- Spell tab buttons -->
      <div class="spell-tabs">
        <!--
        This input's value names the currently selected tab.
        its value is used for css selection of its siblings.
        -->
        <input class="tabcontrol" name="attr_chosenspelltype" type="hidden" value="arcane" />
        <button class="tab" name="act_arcane" type="action">Arcane</button>
        <button class="tab" name="act_divine" type="action">Divine</button>
        <button class="tab" name="act_innate" type="action">Innate</button>

        &emsp; &emsp;
        <div class="spell-header-action-area">
          <div class="label wide larger">Spell Hit</div>
          <input name="attr_spell_hit" type="hidden" />
          <span class="center bold larger middle" name="attr_spell_hit"></span>
          <input class="skillbase" name="attr_spell_hit_modifier" type="number" />
          <button class="spellRoll updateRollSectionContent" name="act_updateRollSectionContent_spell_hit" type="action">&#8679;</button>
          <div class="label wide larger">Affliction</div>
          <input name="attr_affliction" type="hidden" />
          <span class="center bold larger middle" name="attr_affliction"></span>
          <input class="skillbase" name="attr_affliction_modifier" type="number" />
          <button class="spellRoll updateRollSectionContent" name="act_updateRollSectionContent_affliction" type="action">&#8679;</button>
          <div class="label wide larger">Mental</div>
          <input name="attr_mental" type="hidden" />
          <span class="center bold larger middle" name="attr_mental"></span>
          <input class="skillbase" name="attr_mental_modifier" type="number" />
          <button class="spellRoll updateRollSectionContent" name="act_updateRollSectionContent_mental" type="action">&#8679;</button>
        </div>
      </div>
      <!-- Arcane spells -->
      <div class="arcane section">
        <input name="attr_arcane_total_FP" type="hidden" value="0" />
        <input name="attr_arcane_total_CP" type="hidden" value="0" />
        <input name="attr_arcane_total_single_CP" type="hidden" value="0" />
        <div class="arcane epic-table-header-grid">
          <div class="skilldisciplineinfo-grid narrow-table-heading">Discipline?</div>
          <div class="skillname-grid">Name</div>
          <div class="skillability-grid">Ability</div>
          <div class="skillbase-grid">Mod</div>
          <div class="skill--gridroll"></div>
          <div class="spellEP-grid">PWR</div>
          <div class="spellcasttime-grid">Cast Time</div>
          <div class="spelltype-grid">Touch/ Ray/ Missile</div>
          <div class="spellrange-grid">Range</div>
          <div class="spelltarget-grid">Target</div>
          <div class="spellduration-grid">Damage/ Duration</div>
          <div class="spellhasnote-grid">Notes</div>
          <div class="skillFP-grid">
            <input name="attr_remaining_fp" type="hidden" value="0" />
            <span>
              FP
              (<span class="FP" name="attr_remaining_fp"></span>)</span>
          </div>
          <div class="skillCP-grid">
            <input name="attr_remaining_cp" type="hidden" value="0" />
            <span>
              CP
              (<span class="CP" name="attr_remaining_cp"></span>)</span>
          </div>
          <div class="skillexpertise-grid">Exper.</div>
          <div class="skillattribute-grid arcane-iq-plus-minus-attribute">IQ &pm;</div>
          <div class="skillbase-grid">Base</div>
        </div>
        <fieldset class="repeating_arcane">
          <select class="skilldisciplineinfo-grid" name="attr_skilldisciplineinfo">
            <option value=" "></option>
            <option value="D">D</option>
            <option value="â‡¡">&#x21E1;</option>
          </select>
          <!--
          The next input puts whether we are a discipline into the
          value property, where CSS can see it
          -->
          <input class="isdiscipline-grid" name="attr_skillisdiscipline" type="hidden" />
          <input class="skillname-grid" name="attr_skillname" type="text" />
          <span class="skillability-grid" name="attr_skillability"></span>
          <!-- Make the button able to access the ability -->
          <input name="attr_skillability" hidden="true" />
          <input class="skillbase-grid" name="attr_skillmodifier" type="number" />
          <button class="skill-grid-roll updateRollSectionContent" name="act_updaterollsectioncontent" type="action">&#8679;</button>
          <input class="spellEP-grid" name="attr_spellEP" type="text" />
          <input class="spellcasttime-grid" name="attr_spellcasttime" type="text" />
          <select class="spelltype-grid" name="attr_spelltype" type="text">
            <option value="-">None</option>
            <option value="touch">Touch</option>
            <option value="ray">Ray</option>
            <option value="missile">Missile</option>
          </select>
          <input class="spellrange-grid" name="attr_spellrange" type="text" />
          <input class="spelltarget-grid" name="attr_spelltarget" type="text" />
          <input class="spellduration-grid" name="attr_spellduration" type="text" />
          <div class="spellNotesPopover">
            <input class="spellnote-hidden" name="attr_spellnote" type="hidden" />
            <button class="popoverButton" name="act_togglepopoverspellnote" type="action"></button>
            <!--
            The next input puts whether we have a note into the
            value property, where CSS can see it
            -->
            <input class="popoverController" name="attr_visiblepopover" type="hidden" value="false" />
            <div class="spellNotePopover popoverContainer">
              <div class="popoverBackdrop">
                <button name="act_closepopoverspellnotes" type="action">Close popover</button>
              </div>
              <div class="popover fixedPlacementPopover">
                <!-- Buttons in a popover break stacking order, and pop out of the repeating stack.-->
                <button class="closePopoverButton" name="act_closepopoverspellnotes" type="action">X</button>
                <h2>
                  <span class="spell-name" name="attr_skillname"></span>
                </h2>
                <div class="small-spacer"></div>
                <label>Name</label>
                <input class="skillname-grid" name="attr_skillname" type="text" />
                <div class="small-spacer"></div>
                <label>Spell Notes</label>
                <textarea class="spell-note" name="attr_spellnote" rows="6"></textarea>
                <div class="extra-spell-attributes">
                  <div class="attribute-section">
                    <label>PWR</label>
                    <input class="spellEP-grid" name="attr_spellEP" type="number" />
                  </div>
                  <div class="attribute-section">
                    <label>Range</label>
                    <input class="spellrange-grid" name="attr_spellrange" type="text" />
                  </div>
                  <div class="attribute-section">
                    <label>Target</label>
                    <input class="spelltarget-grid" name="attr_spelltarget" type="text" />
                  </div>
                  <div class="attribute-section">
                    <label>Damage/Duration</label>
                    <input class="spellduration-grid" name="attr_spellduration" type="text" />
                  </div>
                </div>
                <div class="small-spacer"></div>
                <button name="act_closepopoverspellnotes" type="action">Close</button>
              </div>
            </div>
          </div>
          <span class="skillFP-grid center" name="attr_skillFP"></span>
          <span class="skillCP-grid center" name="attr_skillCP"></span>
          <select class="skillexpertise-grid" name="attr_skillexpertise">
            <option value="--">--</option>
            <option value="B">b</option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
          </select>
          <input name="attr_skilldisciplineexpertise" type="hidden" />
          <input name="attr_skillattribute" value="IQ" type="hidden" />
          <span class="skillattribute-grid arcane-iq-plus-minus-attribute">IQ &pm;</span>
          <input class="skillbase-grid" name="attr_skillbase" type="number" value="" />
        </fieldset>
      </div>
      <div class="divine section divine-spells-grid">
        <input name="attr_divine_total_CP" type="hidden" value="0" />
        <input name="attr_divine_total_single_CP" type="hidden" value="0" />
        <div class="divine epic-table-header-grid">
          <div class="skillname-grid">Name</div>
          <div class="spellhasnote-grid">Notes</div>
          <div class="spellEP-grid">PWR</div>
          <div class="spellcasttime-grid">Cast Time</div>
          <div class="spelltype-grid">Touch/ Ray/ Missile</div>
          <div class="spellrange-grid">Range</div>
          <div class="spelltarget-grid">Target</div>
          <div class="spellduration-grid">Damage/ Duration</div>
        </div>
        <fieldset class="repeating_divine">
          <input class="skillname-grid" name="attr_skillname" type="text" />
          <div class="spellNotesPopover">
            <input class="spellnote-hidden" name="attr_spellnote" type="hidden" />
            <button class="popoverButton" name="act_togglepopoverspellnote" type="action"></button>
            <!--
            The next input puts whether we have a note into the
            value property, where CSS can see it
            -->
            <input class="popoverController" name="attr_visiblepopover" type="hidden" value="false" />
            <div class="spellNotePopover popoverContainer">
              <div class="popoverBackdrop">
                <button name="act_closepopoverspellnotes" type="action">Close popover</button>
              </div>
              <div class="popover fixedPlacementPopover">
                <!-- Buttons in a popover break stacking order, and pop out of the repeating stack.-->
                <button class="closePopoverButton" name="act_closepopoverspellnotes" type="action">X</button>
                <h2>
                  <span class="spell-name" name="attr_skillname"></span>
                </h2>
                <div class="small-spacer"></div>
                <label>Name</label>
                <input class="skillname-grid" name="attr_skillname" type="text" />
                <div class="small-spacer"></div>
                <label>Spell Notes</label>
                <textarea class="spell-note" name="attr_spellnote" rows="6"></textarea>
                <div class="extra-spell-attributes">
                  <div class="attribute-section">
                    <label>PWR</label>
                    <input class="spellEP-grid" name="attr_spellEP" type="number" />
                  </div>
                  <div class="attribute-section">
                    <label>Range</label>
                    <input class="spellrange-grid" name="attr_spellrange" type="text" />
                  </div>
                  <div class="attribute-section">
                    <label>Target</label>
                    <input class="spelltarget-grid" name="attr_spelltarget" type="text" />
                  </div>
                  <div class="attribute-section">
                    <label>Damage/Duration</label>
                    <input class="spellduration-grid" name="attr_spellduration" type="text" />
                  </div>
                </div>
                <div class="small-spacer"></div>
                <button name="act_closepopoverspellnotes" type="action">Close</button>
              </div>
            </div>
          </div>
          <input class="spellEP-grid" name="attr_spellEP" type="number" />
          <input class="spellcasttime-grid" name="attr_spellcasttime" type="text" />
          <select class="spelltype-grid" name="attr_spelltype" type="text">
            <option value="-">None</option>
            <option value="touch">Touch</option>
            <option value="ray">Ray</option>
            <option value="missile">Missile</option>
          </select>
          <input class="spellrange-grid" name="attr_spellrange" type="text" />
          <input class="spelltarget-grid" name="attr_spelltarget" type="text" />
          <input class="spellduration-grid" name="attr_spellduration" type="text" />
        </fieldset>
      </div>
      <div class="innate section innate-spells-grid">
        <input name="attr_innate_total_CP" type="hidden" value="0" />
        <input name="attr_innate_total_single_CP" type="hidden" value="0" />
        <div class="innate epic-table-header-grid">
          <div class="skill-innatesphere-grid epic-tooltip narrow-table-heading">Sphere<span class="epic-tooltip-text">Spell Sphere</span>
          </div>
          <div class="skillname-grid">Name</div>
          <div class="spellhasnote-grid">Notes</div>
          <div class="spellEP-grid">PWR</div>
          <div class="spellcasttime-grid">Cast Time</div>
          <div class="spelltype-grid">Touch/ Ray/ Missile</div>
          <div class="spellrange-grid">Range</div>
          <div class="spelltarget-grid">Target</div>
          <div class="spellduration-grid">Damage/ Duration</div>
          <div class="skillCP-grid">
            <input name="attr_remaining_cp" type="hidden" value="0" />
            <span>
              CP
              (<span class="CP" name="attr_remaining_cp"></span>)</span>
          </div>
        </div>
        <fieldset class="repeating_innate">
          <select class="skill-innatesphere-grid" name="attr_skillinnatesphere">
            <option value=" "></option>
            <option value="S">S</option>
          </select>
          <!-- The next input allows targeting in CSS-->
          <input class="innatesphere-hidden" name="attr_skillinnatesphere" type="hidden" />
          <input class="skillname-grid" name="attr_skillname" type="text" />
          <div class="spellNotesPopover">
            <input class="spellnote-hidden" name="attr_spellnote" type="hidden" />
            <button class="popoverButton" name="act_togglepopoverspellnote" type="action"></button>
            <!--
            The next input puts whether we have a note into the
            value property, where CSS can see it
            -->
            <input class="popoverController" name="attr_visiblepopover" type="hidden" value="false" />
            <div class="spellNotePopover popoverContainer">
              <div class="popoverBackdrop">
                <button name="act_closepopoverspellnotes" type="action">Close popover</button>
              </div>
              <div class="popover fixedPlacementPopover">
                <!-- Buttons in a popover break stacking order, and pop out of the repeating stack.-->
                <button class="closePopoverButton" name="act_closepopoverspellnotes" type="action">X</button>
                <h2>
                  <span class="spell-name" name="attr_skillname"></span>
                </h2>
                <div class="small-spacer"></div>
                <label>Name</label>
                <input class="skillname-grid" name="attr_skillname" type="text" />
                <div class="small-spacer"></div>
                <label>Spell Notes</label>
                <textarea class="spell-note" name="attr_spellnote" rows="6"></textarea>
                <div class="extra-spell-attributes">
                  <div class="attribute-section">
                    <label>PWR</label>
                    <input class="spellEP-grid" name="attr_spellEP" type="number" />
                  </div>
                  <div class="attribute-section">
                    <label>Range</label>
                    <input class="spellrange-grid" name="attr_spellrange" type="text" />
                  </div>
                  <div class="attribute-section">
                    <label>Target</label>
                    <input class="spelltarget-grid" name="attr_spelltarget" type="text" />
                  </div>
                  <div class="attribute-section">
                    <label>Damage/Duration</label>
                    <input class="spellduration-grid" name="attr_spellduration" type="text" />
                  </div>
                </div>
                <div class="small-spacer"></div>
                <button name="act_closepopoverspellnotes" type="action">Close</button>
              </div>
            </div>
          </div>
          <input class="spellEP-grid" name="attr_spellEP" type="text" />
          <input class="spellcasttime-grid" name="attr_spellcasttime" type="text" />
          <select class="spelltype-grid" name="attr_spelltype" type="text">
            <option value="-">None</option>
            <option value="touch">Touch</option>
            <option value="ray">Ray</option>
            <option value="missile">Missile</option>
          </select>
          <input class="spellrange-grid" name="attr_spellrange" type="text" />
          <input class="spelltarget-grid" name="attr_spelltarget" type="text" />
          <input class="spellduration-grid" name="attr_spellduration" type="text" />
          <input class="skillCP-grid" name="attr_skillCP" type="number" />
        </fieldset>
      </div>
    </div>
    <!-- Notes section -->
    <div class="notes section">
      <div class="flex-stack">
        <p>Utils</p>
        <p>Test Epic Dice
          <button class="actionRollButton epRoll" name="act_epRoll" type="action"></button>
        </p>
        <div class="table-header">
          <div class="notecategory">Category</div>
          <div class="notenote">Note</div>
        </div>
        <fieldset class="repeating_note">
          <input class="notecategory" name="attr_notecategory" type="text" />
          <input class="notenote" name="attr_notenote" type="text" />
        </fieldset>
      </div>
    </div>
  </div>
</div>
<!-- Scripts -->

<script type="text/worker">
  const uniqueIds = new Set();

/**
 * generateRowID() doesn't always generate a unique value.
 * See:
 * https://app.roll20.net/forum/post/8879969/generaterowid-does-not-always-generate-a-star-unique-star-rowid
 */
// eslint-disable-next-line no-unused-vars
function generateTrulyUniqueRowId() {
  let newId = generateRowID();
  while(uniqueIds.has(newId)) {
    newId = generateRowID();
  }
  uniqueIds.add(newId);
  return newId;
}
  'use strict';
/**
 * See also: https://wiki.roll20.net/Sheet_Worker_Scripts#setAttrs.28values.2Coptions.2Ccallback.29
 */
// ----- Utilities -----
const removeNonNumeric = function (s) {
  return String(s).trim().replace(/[^\d.-]/g, '');
};

// Strip out any non-numeric stuff, then interpret the string as a float.
// For example, this will turn '5+S' into 5.
const getNumberPart = function (s) {
  let str = removeNonNumeric(s);
  if (!str) {
    return 0;
  } else {
    let f = parseFloat(str);
    if (isNaN(f)) {
      return 0;
    } else {
      return f;
    }
  }
};

// If the string represents a number, return its value. Otherwise return 0. 
function getNumberIfValid(stringValue) {
  const value = Number(stringValue);
  if (Number.isNaN(value)) {
    return 0;
  }
  return value;
}

const roundToTwoPlaces = function (s) {
  return Math.floor(s * 100) / 100;
};

const sumValues = function (value_map) {
  return Object.values(value_map).reduce(
    (accum, b) => accum + getNumberPart(b), 0);
};

const isEmptyValue = function (value) {
  return value === undefined || value.trim() === '';
};

// Add up the total cost for repeating_<section>:<name>FP
// and put it in <section>_total_FP
const updateTotalFP = function (section, name) {
  if (name === undefined) { name = section; }
  getSectionIDs(section, function (ids) {
    let FP_fields = ids.map(id => `repeating_${section}_${id}_${name}FP`);
    getAttrs(FP_fields, function (fps) {
      let update = {};
      update[section + '_total_FP'] = sumValues(fps);
      setAttrs(update);
    });
  });
};

// Add up the total cost for repeating_<section>:<name>CP
// and put it in <section>_total_CP
const updateTotalCP = function (section, name) {
  if (name === undefined) { name = section; }
  getSectionIDs(section, function (ids) {
    let CP_fields = ids.map(id => `repeating_${section}_${id}_${name}CP`);
    getAttrs(CP_fields, function (cps) {
      let update = {};
      update[section + '_total_CP'] = sumValues(cps);
      setAttrs(update);
    });
  });
};


const getSectionIDsOrdered = function (sectionName, callback) {
  const order_name = `_reporder_repeating_${sectionName}`;
  getAttrs([order_name], function (v) {
    getSectionIDs(sectionName, function (idArray) {
      let reporderArray = (v[order_name] ?
          v[order_name].toLowerCase().split(',') :
          []),
        still_present = reporderArray.filter(x => idArray.includes(x));
      callback([...new Set(still_present.concat(idArray))]);
    });
  });
};

// ----- Top action and roll -----

const toggleSavePending = function () {
  getAttrs(['save_pending'],
    function (values) {
      let new_value = Number(values['save_pending']) ? 0 : 1;
      setAttrs({ 'save_pending': new_value });
    });
};
on('clicked:saveroll', toggleSavePending);

const numericRollKeys = [
  'action_feats',
  'action_EP',
  'action_SP',
  'roll_ability',
  'roll_mod1',
  'roll_mod2',
  'roll_mod3',
  'roll_advance_boost',
];
const roll_keys = [
  'action_description',
  'roll_skill',
  ...numericRollKeys,
];

const saveRollState = function (key, roll_chosen) {
  getAttrs(roll_keys,
    function (values) {
      let update = {
        'save_pending': 0,
        'roll_chosen': roll_chosen
      };
      // We write the values in a fixed order, so we can do equality
      // checks.
      update[key] = JSON.stringify(values, roll_keys);
      setAttrs(update);
    });
};

const loadRollState = function (key, roll_chosen) {
  getAttrs([key],
    function (values) {
      if (values[key] !== '') {
        let change = JSON.parse(values[key]);
        change['roll_chosen'] = roll_chosen;
        setAttrs(change);
        return true;
      } else {
        return false;
      }
    });
};

const checkRollChosen = function () {
  getAttrs(['roll_chosen'], function (values) {
    let roll_chosen = Number(values['roll_chosen']);
    if (roll_chosen) {
      let saved_roll = 'saved_roll_' + roll_chosen;
      getAttrs(roll_keys.concat([saved_roll]), function (values) {
        let saved = values[saved_roll];
        let current = JSON.stringify(values, roll_keys);
        if (saved !== current) {
          setAttrs({ 'roll_chosen': '' });
        }
      });
    }
  });
};
on(roll_keys.map(name => 'change:' + name).join(' '), checkRollChosen);

const doChooseRoll = function (number) {
  let saved_roll = 'saved_roll_' + number;
  getAttrs(['save_pending'], function (values) {
    if (Number(values['save_pending'])) {
      saveRollState(saved_roll, number);
    } else {
      loadRollState(saved_roll, number);
    }
  });
};
const roll_choices = ['1', '2', '3', '4', '5', '6'];
roll_choices.forEach(function (value) {
  on(`clicked:choose_roll_${value}`, function () { doChooseRoll(value); });
});

function updateRollSectionContent({ skillName, abilityValue, advanceBoost, power }) {
  const baseNumericContent = {};
  numericRollKeys.forEach((key) => {
    baseNumericContent[key] = 0;
  });

  const rollContent = {
    ...baseNumericContent,
    'action_description': '',
    'roll_skill': skillName,
    'roll_ability': abilityValue,
    'roll_advance_boost': advanceBoost,
  };
  if (isValueDefined(power)) {
    rollContent['action_EP'] = power;
  }
  setAttrs(rollContent);
}
['repeating_skill', 'repeating_arcane'].forEach((sectionName) => {
  on(`clicked:${sectionName}:updateRollSectionContent`, function () {
    console.log('clicked:repeating_skill:updateRollSectionContent');
    getAttrs([
      'repeating_skill_skillname',
      'repeating_skill_skillability',
      'repeating_skill_skillmodifier',
      'repeating_spell_spellEP'
    ], (attributes) => {
      const { ['repeating_skill_skillname']: skillName } = attributes;
      const skillAbility = Number(attributes['repeating_skill_skillability'] ?? 0);
      const advanceBoost = Number(attributes['repeating_skill_skillmodifier'] ?? 0);
      const spellPwr = isValueDefined(attributes['repeating_spell_spellEP']) ?
        Number(attributes['repeating_spell_spellEP'] ?? 0) :
        undefined;
      console.log({skillName, skillAbility, advanceBoost});
      updateRollSectionContent({ skillName, abilityValue: skillAbility, advanceBoost, power: spellPwr });
    });
  });
});

on('clicked:repeating_feat:addrollsectionfeat', function () {
  console.log('clicked:repeating_feat:addrollsectionfeat');
  getAttrs(['repeating_feat_featextraordinary', 'repeating_feat_featname', 'action_description', 'action_feats'], (attributes) => {
    const {
      ['repeating_feat_featextraordinary']: extraordniaryFeat,
      ['repeating_feat_featname']: featName,
      ['action_description']: actionDescription,
      ['action_feats']: actionFeats,
    } = attributes;
    console.log({extraordniaryFeat, featName, actionDescription, actionFeats});
    const featCost = extraordniaryFeat === '1' ? 2 : 1;
    const currentFeatDescriptions = new Set(actionDescription.split(/, ?/).map((value) => value.trim()).filter(Boolean));
    if (currentFeatDescriptions.has(featName)) {
      return;
    }
    currentFeatDescriptions.add(featName);
    setAttrs({
      'action_description': [...currentFeatDescriptions].join(', '),
      'action_feats': Number(actionFeats) + featCost,
    });
  });
});

const GENERAL_UPDATE_ROLL_SECTION_OPTIONS = [{
  actionId: 'updateRollSectionContent_modifier',
  skillName: 'Roll',
  attributes: {
    advanceBoostKey: 'roll_modifier',
  },
}, {
  actionId: 'updateRollSectionContent_IQ',
  skillName: 'Tries to be smart',
  attributes: {
    skillAbilityKey: 'IQ',
    advanceBoostKey: 'IQmodifier',
  },
}, {
  actionId: 'updateRollSectionContent_DX',
  skillName: 'Tries to be nimble',
  attributes: {
    skillAbilityKey: 'DX',
    advanceBoostKey: 'DXmodifier',
  },
}, {
  actionId: 'updateRollSectionContent_BR',
  skillName: 'Tries to be strong',
  attributes: {
    skillAbilityKey: 'BR',
    advanceBoostKey: 'BRmodifier',
  },
}, {
  actionId: 'updateRollSectionContent_spell_hit',
  skillName: 'Hits with spell',
  attributes: {
    skillAbilityKey: 'spell_hit',
    advanceBoostKey: 'spell_hit_modifier',
  },
}, {
  actionId: 'updateRollSectionContent_affliction',
  skillName: 'Affliction attack',
  attributes: {
    skillAbilityKey: 'affliction',
    advanceBoostKey: 'affliction_modifier',
  },
}, {
  actionId: 'updateRollSectionContent_mental',
  skillName: 'Mental attack',
  attributes: {
    skillAbilityKey: 'mental',
    advanceBoostKey: 'mental_modifier',
  },
}];

GENERAL_UPDATE_ROLL_SECTION_OPTIONS.forEach((rollOption) => {
  const { actionId, skillName, attributes } = rollOption;
  on(`clicked:${actionId}`, () => {
    const { skillAbilityKey, advanceBoostKey } = attributes;
    getAttrs([skillAbilityKey, advanceBoostKey].filter(Boolean), (values) => {
      const abilityValue = Number(values[skillAbilityKey] ?? 0);
      const advanceBoost = Number(values[advanceBoostKey] ?? 0);

      updateRollSectionContent({ skillName,abilityValue, advanceBoost });
    });
  });
});

const topActionDeltas = function (values) {
  let action_feats = Number(values['action_feats']);
  let feats_EP = action_feats;
  let action_EP = Number(values['action_EP']);
  let action_SP = Number(values['action_SP']);
  return {
    'EPS': (action_feats !== 0 ? [-feats_EP] : []).concat(
      (action_EP !== 0 ? [-action_EP] : [])),
    'SPS': action_SP !== 0 ? [-action_SP] : []
  };
};

const topRollDeltas = function (values) {
  let advance_boost = Number(values['roll_advance_boost']);
  let boost_EP = advance_boost;
  return {
    'EPS': advance_boost !== 0 ? [-boost_EP] : [],
    'SPS': []
  };
};

const addDeltas = function (deltas1, deltas2) {
  return {
    'EPS': deltas1['EPS'].concat(deltas2['EPS']),
    'SPS': deltas1['SPS'].concat(deltas2['SPS'])
  };
};

const multiplyDeltas = function (deltas, multiplier) {
  return {
    'EPS': deltas['EPS'].map(x => x * multiplier),
    'SPS': deltas['SPS'].map(x => x * multiplier)
  };
};

const modifiersToTotal = function (modifiers) {
  return modifiers.reduce((accum, modifier) => accum + modifier,
    0);
};

const modifiersToString = function (modifiers) {
  return modifiers.reduce(function (accum, modifier) {
    if (modifier === 0) {
      return accum;
    } else if (modifier > 0) {
      return accum + '+' + String(modifier);
    } else {
      return accum + String(modifier);
    }
  },
  '');
};

const isLegalUpdate = function (current, deltas) {
  return ((-modifiersToTotal(deltas['EPS']) <= Number(current['EP_t']))
    && (-modifiersToTotal(deltas['SPS']) <= Number(current['SP'])));
};

const makeUpdate = function (current, deltas) {
  let EP_delta = modifiersToTotal(deltas['EPS']);
  const current_EP_t = Number(current['EP_t']);
  const EP_t_max = Number(current['EP_t_max']);
  const new_EP_t = Math.max(0, Math.min(EP_t_max * 2, current_EP_t + EP_delta));
  // log("EP_delta " + EP_delta + "  current_EP_t " + current_EP_t);
  // log("EP_t_max " + EP_t_max + "  new_EP_t" + new_EP_t);
  return {
    'EP_t': new_EP_t,
    'SP': Number(current['SP']) + modifiersToTotal(deltas['SPS'])
  };
};

const deltasDescription = function (deltas) {
  let description = '';
  if (deltas['EPS'].length) {
    description = (description + ' ('
      + modifiersToString(deltas['EPS']) + ' EP)');
  }
  if (deltas['SPS'].length) {
    description = (description + ' ('
      + modifiersToString(deltas['SPS']) + ' SP)');
  }
  return description;
};

const topRollCommand = function (values) {
  let ability = Number(values['roll_ability']);
  let modifiers = [Number(values['roll_mod1']),
    Number(values['roll_mod2']),
    Number(values['roll_mod3']),
    Number(values['roll_advance_boost'])];
  let base = ability + modifiersToTotal(modifiers);
  let description = (values['roll_skill'] + ' '
    + String(ability) + modifiersToString(modifiers));
  return '!EPRoll ' + String(base) + ' Tries ' + description;
};

const doTopRoll = function () {
  getAttrs(['EP_t', 'EP_t_max', 'SP',
    'action_description', 'action_feats',
    'action_EP', 'action_SP',
    'roll_skill', 'roll_ability',
    'roll_mod1', 'roll_mod2', 'roll_mod3', 'roll_advance_boost'],
  function (values) {
    let deltas = addDeltas(topActionDeltas(values),
      topRollDeltas(values));
    let update = makeUpdate(values, deltas);
    let description = (values['action_description']
        + deltasDescription(deltas));
    if (description !== '') {
      description = description + '\n';
    }
    update['pendingchat'] = description + topRollCommand(values);
    setAttrs(update);
  });
};
on('clicked:toproll', doTopRoll);

const undoTopRoll = function () {
  getAttrs(['EP_t', 'EP_t_max', 'SP',
    'action_feats', 'action_EP', 'action_SP',
    'roll_advance_boost'],
  function (values) {
    let deltas = multiplyDeltas(addDeltas(topActionDeltas(values),
      topRollDeltas(values)),
    -1);
    let update = makeUpdate(values, deltas);
    let restored = deltasDescription(deltas);
    if (restored !== '') {
      update['pendingchat'] = 'Undo restoring' + restored;
    }
    setAttrs(update);
  });
};
on('clicked:undotoproll', undoTopRoll);

const EP_ROLL_OPTIONS = [{
  actionId: 'epRoll',
  attributes: [],
  getChatMessage: () => {
    return '!EPRoll';
  },
}, {
  actionId: 'epRoll_roll_modifier',
  attributes: ['roll_modifier'],
  getChatMessage: (values) => {
    const { roll_modifier } = values;
    return `!EPRoll ${roll_modifier}`;
  },
}, {
  actionId: 'epRoll_initiative',
  attributes: ['initiative', 'initiativemodifier', 'character_id'],
  getChatMessage: (values) => {
    const { initiative, initiativemodifier, character_id } = values;
    return `!EPRoll ${initiative}+${initiativemodifier} Rolls initiative ${initiative} + ${initiativemodifier} SEND_TO_TRACKER ${character_id}`;
  },
}, {
  actionId: 'epRoll_IQmodifier',
  attributes: ['IQ', 'IQmodifier'],
  getChatMessage: (values) => {
    const { IQ, IQmodifier } = values;
    return `!EPRoll ${IQ}+${IQmodifier} Tries to be smart: ${IQ} + ${IQmodifier}`;
  },
}, {
  actionId: 'epRoll_DXmodifier',
  attributes: ['DX', 'DXmodifier'],
  getChatMessage: (values) => {
    const { DX, DXmodifier } = values;
    return `!EPRoll ${DX}+${DXmodifier} Tries to be nimble: ${DX} + ${DXmodifier}`;
  },
}, {
  actionId: 'epRoll_BRmodifier',
  attributes: ['BR', 'BRmodifier'],
  getChatMessage: (values) => {
    const { BR, BRmodifier } = values;
    return `!EPRoll ${BR}+${BRmodifier} Tries to be strong: ${BR} + ${BRmodifier}`;
  },
}];

EP_ROLL_OPTIONS.forEach((rollOption) => {
  const { actionId, attributes, getChatMessage } = rollOption;
  on(`clicked:${actionId}`, () => {
    getAttrs(attributes, (values) => {
      setAttrs({ pendingchat: getChatMessage(values) });
    });
  });
});

const updateTopActEnables = function () {
  log('Updating top action enables');
  getAttrs(['EP_t', 'SP',
    'action_feats', 'action_EP', 'action_SP', 'roll_advance_boost'],
  function (values) {
    let top_action_deltas = topActionDeltas(values);
    let top_roll_deltas = addDeltas(topActionDeltas(values),
      topRollDeltas(values));
    log(values);
    log(top_action_deltas);
    let update = {
      'disable_do_and_roll':
          isLegalUpdate(values, top_roll_deltas) ? '0' : '1'
    };
    log(update);
    setAttrs(update);
  });
};

on(
  'change:ep_t ' +
  'change:sp ' +
  'change:action_feats ' +
  'change:action_ep ' +
  'change:action_sp ' +
  'change:roll_advance_boost',
  updateTopActEnables);

// ----- EP_t, and SP ----
const updateEP = function () {
  const power = 'power';
  const EP_t_max = 'EP_t_max';
  const SP_max = 'SP_max';
  getAttrs([power, EP_t_max, SP_max], function (values) {
    let power_v = Number(values[power]);
    const EP_t_max_v = Number(values[EP_t_max]);
    const SP_max_v = Number(values[SP_max]);
    const power_points = (power_v < 6 ?
      power_v :
      Math.floor(5 * (Math.sqrt(power_v - 1) - 1)));
    const new_SP_max = Math.floor((power_points - 3 * EP_t_max_v) / 2);
    // We get called from spurrios changes to SP_max,
    // So only reset all the values if something actually changed.
    log('EP_t: ' + EP_t_max_v + '  SP: ' + SP_max_v
      + '  new SP: ' + new_SP_max);
    if (new_SP_max !== SP_max_v) {
      setAttrs({
        'EP_t': EP_t_max_v,
        'SP_max': new_SP_max,
        'SP': new_SP_max
      });
    }
  });
};
on('change:power change:ep_t_max', updateEP);

const fixPower = function () {
  const power = 'power';
  const EP_max = 'EP_max';
  const SP_max = 'SP_max';
  getAttrs([power, EP_max, SP_max], function (values) {
    let power_v = Number(values[power]);
    const EP_max_v = Number(values[EP_max]);
    const SP_max_v = Number(values[SP_max]);
    // Set power to EP if we have an old sheet, where it wasn't set yet.
    if (power_v === 0 && SP_max_v === 0 && EP_max_v > 0) {
      power_v = EP_max_v;
    }
    setAttrs({ 'power': power_v }, null, updateEP);
  });
};
on('sheet:opened', fixPower);

// ----- Tab navigation -----
['overview', 'basic', 'equipment', 'skills', 'spells', 'notes'].forEach(
  button => {
    on(`clicked:${button}`, function () {
      setAttrs({ chosentab: button });
    });
  });

// ----- Popovers -----
// Close all popovers on page load
function closePopovers() {
  setAttrs({ chosenPopover: 'false' });
}
on('sheet:opened', closePopovers);
['weightPenalties', 'addBaseSkills'].forEach(
  popoverToToggle => {
    on(`clicked:popover_${popoverToToggle}`, function () {
      getAttrs(['chosenPopover'], (attributes) => {
        const { chosenPopover } = attributes;
        setAttrs({ chosenPopover: chosenPopover === popoverToToggle ? 'false' : popoverToToggle });
      });
    });
  });

function setupSpellNotes(spellDomain) {
  function closeAllSpellNotes() {
    getSectionIDs(`repeating_${spellDomain}`, function (ids) {
      console.log('*** Close all spell notes ***');
      ids.forEach((id) => {
        setAttrs({ [`repeating_${spellDomain}_${id}_visiblepopover`]: 'false' });
      });
    });
  }

  on('sheet:opened', closeAllSpellNotes);

  on(`clicked:repeating_${spellDomain}:togglepopoverspellnote`, function () {
    closeAllSpellNotes();
    getAttrs([`repeating_${spellDomain}_visiblepopover`], (attributes) => {
      const { [`repeating_${spellDomain}_visiblepopover`]: visiblePoppover } = attributes;
      setAttrs({ [`repeating_${spellDomain}_visiblepopover`]: visiblePoppover === 'false' ? '1' : 'false' });
    });
  });

  on(`clicked:repeating_${spellDomain}:closepopoverspellnotes`, closeAllSpellNotes);
}
['arcane', 'divine', 'innate'].forEach(setupSpellNotes);

// ----- Focus points -----
const updateFP = function () {
  const CP = 'CP';
  // const FP = 'FP';
  getAttrs([CP], function (values) {
    const FP_v = Math.floor(Number(values[CP]) / 5);
    setAttrs({ 'FP': FP_v });
  });
};
on('change:cp sheet:opened', updateFP);

// ----- Attribute costs -----
const updateAttributeCost = function () {
  getAttrs(['IQ', 'DX', 'BR'], function (attributes) {
    const values = [Number(attributes.IQ),
                        Number(attributes.DX),
                        Number(attributes.BR)]
    values.sort((a,b) => a - b);
    let total = values.reduce((acc, x) => acc + x);
    // The total is normally 3, but not if a species adjusts it.
    // Get the unadjusted values, making the most charitable assumption.
    if (total === 2) {
      // Maybe an attribute got reduced. Assume it was the lowest one.
      values[0] += 1;
    } else if (total === 4) {
      // Maybe an attribute got increased. Assume it was the highest one.
      values[2] -= 1;
    }
    total = values.reduce((acc, x) => acc + x);
    let cost = '??';
    if (total === 3) {
      const total_squares = values.reduce((acc, x) => acc + x**2, 0);
      if (total_squares === 3) {
        cost = -2;
      } else if (total_squares === 5) {
        cost = 0;
      } else if (total_squares <= 9) {
        cost = 4;
      }
    }
    setAttrs({
      displayed_attribute_CP: String(cost),
      attribute_CP: cost === '??' ? 0 : cost
    });
  });
};
on('change:iq change:dx change:br', updateAttributeCost);

function updateRemainingCp() {
  const attributeNames = [
    'attribute_CP',
    'advantage_total_CP',
    'feat_total_CP',
    'skill_total_CP',
    'arcane_total_CP',
    'innate_total_CP',
  ];
  getAttrs(['CP', ...attributeNames], function (values) {
    const CP = Number(values.CP);
    const usedCp = attributeNames.reduce((memo, name) => memo + Number(values[name]), 0);
    setAttrs({ remaining_cp: CP - usedCp });
  });
}
on('change:CP' +
  ' change:attribute_CP ' +
  ' change:advantage_total_CP' +
  ' change:feat_total_CP' +
  ' change:skill_total_CP' +
  ' change:arcane_total_CP' +
  ' change:innate_total_CP' +
  ' sheet:opened', updateRemainingCp);

function updateRemainingFp() {
  const attributeNames = [
    'skill_total_FP',
    'arcane_total_FP',
  ];
  getAttrs(['FP', ...attributeNames], function (values) {
    const FP = Number(values.FP);
    const usedFp = attributeNames.reduce((memo, name) => memo + Number(values[name]), 0);
    setAttrs({ remaining_fp: FP - usedFp });
  });
}
on('change:FP' + 
  ' change:skill_total_FP' + 
  ' change:arcane_total_FP' + 
  ' sheet:opened', updateRemainingFp);

// ----- Advantage and disadvantage costs -----
const advantageCosts = {
  healthy: 2,
  packmule: 2,
  strongarms: 3,
  brute: 1,
  fast: 2,
  athlete: 1,
  alert: 1,
  wary: 1,
  attractive: 1,
  mage: 3,
  devout: 3,
};
// const advantageNameTranslations = {
//   packmule: 'Pack Mule',
//   strongarms: 'Strong Arms',
//   athlete: 'Natural Athlete',
// };

// Advantages used to be stored as _plus or _minus, rather than as _count.
// Go through all of those, transfer them to _count, and eliminate them.
const migrateAdvantages = function () {
  const fixed_advantage_prefixes = Object.keys(advantageCosts).map(
    advantage => 'advantage_' + advantage + '_');
  const fixed_advantage_plus_fields = fixed_advantage_prefixes.map(
    prefix => prefix + 'plus');
  const fixed_advantage_minus_fields = fixed_advantage_prefixes.map(
    prefix => prefix + 'minus');
  getAttrs(fixed_advantage_plus_fields.concat(fixed_advantage_minus_fields),
    function (attributes) {
      const update = {};
      for (const advantage of Object.keys(advantageCosts)) {
        const prefix = 'advantage_' + advantage + '_';
        for (const polarity of ['plus', 'minus']) {
          if (Number(attributes[prefix + polarity]) === 1) {
            update[prefix + 'count'] = polarity === 'plus' ? '1' : '-1';
            update[prefix + polarity] = '0';
          }
        }
      }
      if (Object.keys(update).length > 0) {
        setAttrs(update);
        updateAdvantagesCosts();
      }
    });
};
on('sheet:opened', migrateAdvantages);

// Given a array, where each element is an advantage object containing:
//   {base_cost, count}
// update the objects in the array to also contain a cost_description
// property, which will be a string like "3" or "2*4", that describes
// how the cost of that advantage was computed.
// Return the total of all the costs.
// The order of the elements of the array may be changed by the function.
const calculateAdvantageCosts = function (advantages) {
  log('Calculating');
  // Sort them from most expensive to least.
  advantages.sort(function (a, b) { return b.base_cost - a.base_cost; });
  let seen = 0; // the number of positive advantages we have seen so far
  let total_cost = 0;
  for (const advantage of advantages) {
    const base_cost = Number(advantage.base_cost);
    const count = advantage.count;
    if (count < 0) {
      total_cost += -(base_cost / 2);
      advantage.cost_description = '-' + String(base_cost) + '/2';
    } else if (count > 0) {
      if (base_cost <= 0) {
        total_cost += base_cost;
        advantage.cost_description = String(base_cost);
      } else {
        const multiplier = (seen + 1 + seen + count) * count / 2;
        total_cost += base_cost * multiplier;
        if (multiplier === 1) {
          advantage.cost_description = String(base_cost);
        } else {
          advantage.cost_description = (
            String(multiplier) + 'Ã—' + String(base_cost));
        }
        seen = seen + count;
      }
    } else {
      advantage.cost_description = ' ';
    }
  }
  total_cost = Math.ceil(total_cost); // If any fractional disadvantages were left over, truncate the benefit.
  log('Total cost ' + String(total_cost));
  log('Advantages ' + JSON.stringify(advantages));
  return total_cost;
};

const updateAdvantagesCosts = function () {
  const fixed_advantage_prefixes = Object.keys(advantageCosts).map(
    advantage => 'advantage_' + advantage + '_');
  const fixed_advantage_count_fields = fixed_advantage_prefixes.map(
    prefix => prefix + 'count');
  getSectionIDs('extraadvantage', function (extra_ids) {
    const extra_advantage_cost_fields = extra_ids.map(
      id => 'repeating_extraadvantage_' + id + '_extraadvantageCP');
    getAttrs(fixed_advantage_count_fields.concat(extra_advantage_cost_fields),
      function (attributes) {
        const fixed_advantages = Object.keys(advantageCosts).map(
          function (advantage) {
            const prefix = 'advantage_' + advantage + '_';
            return {
              description_key: prefix + 'CPdescription',
              base_cost: advantageCosts[advantage],
              count: Number(attributes[prefix + 'count'])
            };
          });
        const extra_advantages = extra_ids.map(
          function (extra_id) {
            const prefix = 'repeating_extraadvantage_' + extra_id + '_';
            return {
              description_key: prefix + 'extraadvantageCPdescription',
              base_cost: Number(attributes[prefix + 'extraadvantageCP']),
              count: 1
            };
          });
        const advantages = fixed_advantages.concat(extra_advantages);
        const total_cost = calculateAdvantageCosts(advantages);
        const update = { advantage_total_CP: total_cost };
        for (const advantage of advantages) {
          update[advantage.description_key] = advantage.cost_description;
        }
        setAttrs(update);
      });
  });
};

on(Object.keys(advantageCosts).map(
  advantage => `change:advantage_${advantage}_count`
).join(' '),
updateAdvantagesCosts);

on((
  'change:repeating_extraadvantage:extraadvantageCP ' +
  'remove:repeating_extraadvantage'),
updateAdvantagesCosts);

const updateHPMax = function () {
  const BR = 'BR';
  const healthy = 'advantage_healthy_count';
  getAttrs([BR, healthy], function(values) {
    const effective_BR = (
      Number(values[BR]) +
      Number(values[healthy]));
    const max_hp = (effective_BR <= -3 ?
      8 + effective_BR :
      12 + effective_BR * (effective_BR + 7) / 2);
    setAttrs({ 'HP_max': max_hp });
  });
};
on('change:br change:advantage_healthy_count sheet:opened',
  updateHPMax);

const reset_EP_t = function () {
  const EP_t = 'EP_t';
  const EP_t_max = 'EP_t_max';
  getAttrs([EP_t, EP_t_max], function (values) {
    const EP_t_max_v = Number(values[EP_t_max]);
    setAttrs({ EP_t: EP_t_max_v + Math.min(EP_t_max_v, Number(values[EP_t])) });
  });
};
on('clicked:reset_ep_t', reset_EP_t);

const convertSP = function () {
  const EP_t = 'EP_t';
  const SP = 'SP';
  getAttrs([EP_t, SP], function (attributes) {
    let EP_t_v = Number(attributes[EP_t]);
    let SP_v = Number(attributes[SP]);
    if (SP_v > 0) {
      setAttrs({
        'EP_t': EP_t_v + 2,
        'SP': SP_v - 1
      });
    }
  });
};
on('clicked:convert_sp', convertSP);

const reset_SP = function () {
  const SP_max = 'SP_max';
  getAttrs([SP_max], function (values) {
    setAttrs({ 'SP': values[SP_max] });
  });
};
on('clicked:reset_sp', reset_SP);

const reset_HP = function () {
  const HP_max = 'HP_max';
  getAttrs([HP_max], function (values) {
    setAttrs({ 'HP': values[HP_max] });
  });
};
on('clicked:reset_hp', reset_HP);


// ----- Epic Feats -----

// Set E for extraordinary
on('change:repeating_feat:featextraordinary', function () {
  getAttrs(['repeating_feat_featextraordinary'], function (values) {
    const letter = (
      values.repeating_feat_featextraordinary === '1' ? 'E' : ' ');
    setAttrs({ 'repeating_feat_featextraordinaryletter': letter });
  });
});

on('change:repeating_feat:featcp remove:repeating_feat',
  function () { updateTotalCP('feat'); });

// Set default CP cost
// There is no event for a row being added, so new rows start out with
// empty cost. Then we set it to the usual 4 when a feat name is entered.
on('change:repeating_feat:featname', function (event) {
  let prev_name = event.previousValue;
  const new_name = event.newValue;
  // When a new row is filled in for the first time, previousValue
  // comes back as the new value.
  if (prev_name === new_name) { prev_name = undefined; }
  if (isEmptyValue(prev_name) !== isEmptyValue(new_name)) {
    let field_name_parts = event.sourceAttribute.split('_');
    field_name_parts.pop();
    field_name_parts.push('featCP');
    const CP_field = field_name_parts.join('_');
    getAttrs([field_name_parts.join('_')], function (values) {
      const prev_CP_cost = values[CP_field];
      if (isEmptyValue(prev_CP_cost) === isEmptyValue(prev_name)) {
        let default_value = {};
        default_value[CP_field] = isEmptyValue(new_name) ? '0' : '1';
        setAttrs(default_value);
      }
    });
  }
});

function isValueDefined(value) {
  return value !== null && value !== undefined;
}
// -------- Skills ---------

function updateUserStatistics() {
  getAttrs(['race'], (attrs) => {
    const { race } = attrs;
    getSectionIDs('skill', (ids) => {
      const skillCount = ids.length;
      setAttrs({
        skillCount,
        isNewUser: skillCount === 0 && !race,
      });
    });
  });
}
// The change:repeating_skill:skillname catches new skills.
on('sheet:opened change:race change:repeating_skill:skillname remove:repeating_skill', 
   updateUserStatistics);

function updateEffectiveness() {
  getAttrs(['EP_t_max', 'SP_max', 'HP_max', 'best_weapon_damage', 'best_attack', 'best_attack_is_spell',
            'current_dodge_with_armor', 'current_parry_with_armor', 'current_block_with_armor'], (attrs) => {
    const attack = getNumberIfValid(attrs['best_attack']);
    const defense = Math.max(getNumberIfValid(attrs['current_dodge_with_armor']),
                             getNumberIfValid(attrs['current_parry_with_armor']),
                             getNumberIfValid(attrs['current_block_with_armor']));
    const EP = getNumberIfValid(attrs['EP_t_max']);
    const SP = getNumberIfValid(attrs['SP_max']);
    const HP = getNumberIfValid(attrs['HP_max']);
    const attackIsSpell = getNumberIfValid(attrs['best_attack_is_spell']);
    console.log('attack is spell: ' + attackIsSpell.toString() +
                '  best weapon damage: ' + getNumberIfValid(attrs['best_weapon_damage']).toString());
    const damagePerAttack = (attackIsSpell ?
                             8 :
                             (getNumberIfValid(attrs['best_weapon_damage']) + 2));
    const enemyHealth = 16;
    const damagePerIncomingAttack = 8;
    const normalizingFactor = 0.3
    console.log('EP: ' + EP.toString() +
                '  SP: ' + SP.toString() +
                '  HP: ' + HP.toString() +
                '  damagePerAttack: ' + damagePerAttack.toString() +
                '  attack: ' + attack.toString() +
                '  defense: ' + defense.toString());
    // Most of the damage from a huge attack is wasted on overkill. Even for a modest attack, you expect
    // half the damage of the attack that takes an enemy down to be wasted.
    // This formula estimates that. For small attacks, it gives half the damage, while for huge attacks, it
    // gives everything beyond what is needed to kill.
    const damage_overshoot = damagePerAttack * (enemyHealth + damagePerAttack) / (2*enemyHealth + damagePerAttack);
    console.log('overshoot: ' + damage_overshoot.toString());
    console.log('exp term: ' + (2**((attack + defense + 1.2*EP) * 0.315)).toString());
    console.log('attack term: ' + (damagePerAttack / (enemyHealth + damage_overshoot)).toString());
    console.log('defense term: ' + (HP / damagePerIncomingAttack +
       damagePerIncomingAttack / (damagePerIncomingAttack + HP) +
       SP).toString());
    effectiveness = Math.sqrt(
      // Rate the character hits times how good they are at avoiding hits. Simulations show that the 0.315 factor does
      // a very good job at accounting for both the likelihood of hitting and the extra effectiveness of good hits.
      // The 1.2 factor weights EP a bit more, on the theory that the player can deploy it to wherever it will
      // be most effective.
      2**((attack + defense + 1.2*EP) * 0.315) *
      // Kills per hits by the character
      damagePerAttack / (enemyHealth + damage_overshoot) *
      // Number of hits on the character needed to kill them.
      // The second term is because even a character with only 1 HP takes a full attack to kill.
      // For tiny HP, the term is enough to bring the hits that the first term gives up to 1,
      // while for large HP the term becomes insignificant.
      // The SP term assumes that each SP lets the character avoid one more hit.
      (HP / damagePerIncomingAttack +
       damagePerIncomingAttack / (damagePerIncomingAttack + HP) +
       SP)) * 
      normalizingFactor;
    setAttrs({'effectiveness': roundToTwoPlaces(effectiveness)});
  });
}
on('change:EP change:SP change:HP change:best_weapon_damage change:best_attack change:best_attack_is_spell' +
   ' change:current_dodge_with_armor change:current_parry_with_armor change:current_block_with_armor' +
   ' sheet:opened',
   updateEffectiveness)

// Calculate these ability values from the skills, modify them for the weight
// penalty if appropriate, and set attributes to record the result:
//    guard, spell hit, affliction, mental,
//    best_attack, best_attack_is_spell
// Then update everything that depends on those quantities.
const updateCopiedAbilities = function () {
  const DX = 'DX';
  const IQ = 'IQ';
  const BR = 'BR';
  const weight_penalty = 'weight_penalty';
  getSectionIDsOrdered('skill', function (ids) {
    const disciplineinfoFields = ids.map(
      id => `repeating_skill_${id}_skilldisciplineinfo`);
    const expertiseFields = ids.map(
      id => `repeating_skill_${id}_skillexpertise`);
    const abilityFields = ids.map(
      id => `repeating_skill_${id}_skillability`);
    const nameFields = ids.map(
      id => `repeating_skill_${id}_skillname`);
    getAttrs(disciplineinfoFields.concat(expertiseFields)
      .concat(abilityFields).concat(nameFields)
      .concat([DX, IQ, BR, weight_penalty]), function (values) {
      const DX_n = Number(values[DX]);
      const IQ_n = Number(values[IQ]);
      const BR_n = Number(values[BR]);
      const weight_penalty_n = Number(values[weight_penalty]);
      // Find the ability of the character's best attack: the highest skill under the attack
      // discipline, and note whether it is a spell attack.
      // (Note: a spell attack can easily be a character's best attack, even if they have no focus on it,
      //  Because the base is so high. But we only consider skills that are actualy listed on the sheet,
      //  on the theory those are the ones that the character will actualy be using.) 
      let bestAttack = -5;
      const nonPhysicalAttacks = new Set(['mental attack', 'mental', 'affliction attack', 'affliction']);
      const spellAttacks = nonPhysicalAttacks.union(new Set(['spell hit', // Include obsolete spell attacks
                                                             'spell touch', 'aim spell',
                                                             'engulf with spell', 'engulf']));
      let bestAttackIsSpell = 0;
      let under_attack_discipline = false;
      for (let i = 0; i < ids.length; ++i) {
        if (values[disciplineinfoFields[i]] === 'D') {
          under_attack_discipline = values[nameFields[i]].toLowerCase().trim() === 'attack';
        } else {
          if (values[disciplineinfoFields[i]] === 'â‡¡' && under_attack_discipline) {
            // We have a skill under the attack discipline.
            let ability =  values[abilityFields[i]];
            const normalizedName = values[nameFields[i]].toLowerCase().trim();
            if (nonPhysicalAttacks.has(normalizedName)) {
              // We give a bonus of 1 to non-physical attacks,
              // since the defenses against them are typically worse.
              ability += 1;
            }
            if (ability > bestAttack) {
              bestAttack = ability;
              bestAttackIsSpell = spellAttacks.has(normalizedName) ? 1 : 0;
            }
          }
        }
      }
      console.log('Best attack: ' + bestAttack.toString());
      let update = {'best_attack': bestAttack,
                   'best_attack_is_spell': bestAttackIsSpell};
      // Make a map from skill names to their index.
      let skill_map = _.object(
        nameFields.map(name => values[name].toLowerCase().trim()),
        _.range(ids.length));
      let min_focus_plus_expertises = {};
      for (let discipline of ['defense', 'defend', // Try both ways.
        'attack']) {
        let min_focus_plus_expertise = -5;
        // If the character has the discipline, that gives them
        // a better minimum focus.
        if (discipline in skill_map) {
          const discipline_index = skill_map[discipline];
          const expertise_v = values[expertiseFields[discipline_index]];
          if (values[disciplineinfoFields[discipline_index]] === 'D'
              && expertise_v !== '--') {
            min_focus_plus_expertise = -2 + Number(expertise_v);
          }
        }
        min_focus_plus_expertises[discipline] = min_focus_plus_expertise;
      }
      // Try to find an ability for each skill.
      for (let skill of ['guard', 'spell hit', 'affliction', 'mental']) {
        // First, get the ability assuming there is no training
        let base = (skill === 'guard' ? DX_n - 3 :
                    skill === 'spell hit' ? DX_n + 4 :
                    skill === 'affliction' ? BR_n + 1 :
                    IQ_n + 1)
        let ability = base + (skill === 'guard' ?
                              Math.max(min_focus_plus_expertises['defense'],
                                       min_focus_plus_expertises['defend']):
                              min_focus_plus_expertises['attack']);
        // Check for both alternative names for the skill and obsolete names.
        let possible_names = (skill === 'guard' ? ['guard', 'dodge', 'block', 'shield', 'parry'] :
                              skill === 'spell hit' ? ['spell hit', 'engulf', 'engulf with spell',
                                                       'aim spell', 'spell touch'] :
                              skill === 'affliction' ? ['affliction', 'afflict', 'affliction attack'] :
                              ['mental', 'mental attack']);
        for (let name of possible_names) {
          let skill_index = skill_map[name];
          if (isValueDefined(skill_index) && values[disciplineinfoFields[skill_index]] !== 'D') {
            possible_ability = Number(values[abilityFields[skill_index]]);
            if (name === 'spell touch') {
              possible_ability = possible_ability - 1; // Convert DX+5 to DX+4
            }
            ability = Math.max(ability, possible_ability);
          }
        }
        if (skill === 'guard') {
          ability = ability + weight_penalty_n;
        }
        update[skill.replaceAll(' ', '_')] = ability;
      }
      setAttrs(update);
    });
  });
};
on(
  'change:repeating_skill:skilldisciplineinfo ' +
  'change:repeating_skill:skillexpertise ' +
  'change:repeating_skill:skillability ' +
  'change:repeating_skill:skillname ' +
  'change:DX change:weight_penalty remove:repeating_skill ' +
  'sheet:opened',
  updateCopiedAbilities);

// skilldisciplineexpertise holds the expertise of the discipline that
// applies to the skill. We walk through all the items, in order,
// note which are disciplines (which is used by the CSS),
// and set the discipline expertise of
// all skills to that of the most recent discipline we encountered.
const updateSkillDisciplineExpertises = function (section) {
  getSectionIDsOrdered(section, function (ids) {
    const disciplineinfoFields = ids.map(
      id => `repeating_${section}_${id}_skilldisciplineinfo`);
    const isdisciplineFields = ids.map(
      id => `repeating_${section}_${id}_skillisdiscipline`);
    const expertiseFields = ids.map(
      id => `repeating_${section}_${id}_skillexpertise`);
    const disciplineexpertiseFields = ids.map(
      id => `repeating_${section}_${id}_skilldisciplineexpertise`);
    getAttrs(disciplineinfoFields.concat(isdisciplineFields).concat(expertiseFields)
      .concat(disciplineexpertiseFields),
    function (attributes) {
      let discipline_expertise = 0;
      let update = {};
      for (let i = 0; i < ids.length; ++i) {
        if (attributes[disciplineinfoFields[i]] === 'D') {
          discipline_expertise = attributes[expertiseFields[i]];
          if (attributes[isdisciplineFields[i]] !== '1') {
            update[isdisciplineFields[i]] = '1';
          }
        } else {
          if (attributes[isdisciplineFields[i]] !== '0') {
            update[isdisciplineFields[i]] = '0';
          }
          let this_discipline_expertise = 0;
          if (attributes[disciplineinfoFields[i]] === 'â‡¡') {
            this_discipline_expertise = discipline_expertise;
          }
          if (this_discipline_expertise !== attributes[disciplineexpertiseFields[i]]) {
            update[disciplineexpertiseFields[i]] = this_discipline_expertise;
          }
        }
      }
      if (!_.isEmpty(update)) {
        setAttrs(update);
      }
    });
  });
};

const updateSkillDerivedForId = function (section, row_id) {
  const name = `repeating_${section}_${row_id}_skillname`;
  const disciplineinfo = `repeating_${section}_${row_id}_skilldisciplineinfo`;
  const expertise = `repeating_${section}_${row_id}_skillexpertise`;
  const disciplineexpertise = (
    `repeating_${section}_${row_id}_skilldisciplineexpertise`);
  const attribute = `repeating_${section}_${row_id}_skillattribute`;
  const base = `repeating_${section}_${row_id}_skillbase`;
  const fp = `repeating_${section}_${row_id}_skillFP`;
  const cp = `repeating_${section}_${row_id}_skillCP`;
  const ability = `repeating_${section}_${row_id}_skillability`;
  const mage = 'advantage_mage_count';
  const devout = 'advantage_devout_count';
  getAttrs([name, disciplineinfo, expertise, disciplineexpertise,
    attribute, base, 'IQ', 'DX', 'BR', mage, devout],
  function (values) {
    // Update FP and CP costs
    let update = {};
    if (values[disciplineinfo] === 'D') {
      const cost = ({
        '--': 0,
        'ST': 0,
        'B': 0,
        '-1': 0, // This shouldn't appear any more. But it might be left over from old characters.
        '0': 1,
        '1': 2,
        '2': 4,
        '3': 7,
        '4': 11,
        '5': 16,
        '6': 22,
        '7': 29,
        '8': 37,
        '9': 46
      }[values[expertise]]);
      update[cp] = cost === 0 ? ' ' : cost;
      update[fp] = ' ';
      // Fix illegal values for expertise of discipline.
      if ({ 'ST': true, 'B': true, '-1': true}[values[expertise]]) {
        update[expertise] = '--';
      }
    } else {
      // Negative values indicate CP cost. Positive indicate FP cost.
      const cost = ({
        '--': 0,
        'ST': 0,
        'B': 0,
        '-1': 0, // This shouldn't appear any more. But it might be left over from old characters.
        '0': -1,
        '1': 1,
        '2': 3,
        '3': 6,
        '4': 10,
        '5': 15,
        '6': 21,
        '7': 28,
        '8': 36,
        '9': 45
      }[values[expertise]]);
      update[cp] = cost >= 0 ? ' ' : -cost;
      update[fp] = cost <= 0 ? ' ' : cost;
      // Get rid of any old -1s, which are no longer an option.
      if ({ '-1': true }[values[expertise]]) {
        update[expertise] = '--';
      }
      // Clear base if it is 0.
      if (values[base] === '0') {
        update[base] = ' ';
      }
      // Update ability
      const expertise_v = values[expertise];
      const attribute_v = values[attribute];
      const disciplineexpertise_v = values[disciplineexpertise];
      const disciplineexpertise_n = (
        disciplineexpertise_v === '--' ? 0 : Number(disciplineexpertise_v));
      const IQ_n = Number(values['IQ']);
      const DX_n = Number(values['DX']);
      const BR_n = Number(values['BR']);
      if (attribute_v === '') {
        update[ability] = '??';
      } else {
        /* eslint-disable indent */
        const attribute_value = (
          attribute_v === 'IQ' ? IQ_n :
          attribute_v === 'DX' ? DX_n :
          attribute_v === 'BR' ? BR_n :
          attribute_v === 'IQ+DX' ? IQ_n + DX_n :
          BR_n + DX_n);
        const focus = (
          expertise_v === 'ST' ? -1 :
          expertise_v === 'B' ? -1 :
          expertise_v === '--' ? (disciplineexpertise_n === 0 ? -5 : -2) :
          Number(expertise_v));
        /* eslint-enable indent */
        let ability_v = disciplineexpertise_n + focus + attribute_value + Number(values[base]);
        if (section === 'arcane') {
          ability_v += Number(values[mage]) * 2;
        }
        if (values[name].toLowerCase().trim().startsWith('pray')) {
          ability_v += Number(values[devout]) * 2;
        }
        update[ability] = ability_v;
      }
    }
    setAttrs(update);
  });
};

const updateSkillDerived = function (section, event) {
  const row_id = event.sourceAttribute.split('_')[2];
  updateSkillDerivedForId(section, row_id);
  updateTotalFP(section, 'skill');
  updateTotalCP(section, 'skill');
};

const updateAllSkillsDerived = function (section) {
  getSectionIDs(section, function (ids) {
    for (let i = 0; i < ids.length; ++i) {
      updateSkillDerivedForId(section, ids[i]);
    }
    updateTotalFP(section, 'skill');
    updateTotalCP(section, 'skill');
  });
};

on('change:repeating_skill:skilldisciplineinfo' +
  ' change:repeating_skill:skillexpertise' +
  ' change:repeating_skill:skillname' + // Fires for new skill.
  ' remove:repeating_skill' +
  ' change:_reporder:skill',
function () { updateSkillDisciplineExpertises('skill'); });

on('change:repeating_skill:skilldisciplineinfo' +
  ' change:repeating_skill:skillexpertise' +
  ' change:repeating_skill:skilldisciplineexpertise' +
  ' change:repeating_skill:skillattribute' +
  ' change:repeating_skill:skillbase',
function (event) { updateSkillDerived('skill', event); });

on('change:IQ change:DX change:BR'
  + ' change:advantage_mage_count change:advantage_devout_count',
function () { updateAllSkillsDerived('skill'); });

on('remove:repeating_skill',
  function () {
    updateTotalFP('skill');
    updateTotalCP('skill');
  });

function createBaseSkillsAttributes(includePersonal) {
  const section = 'skill';
  const newAttributes = {};
  function addNewAttributeRow(attributesBySuffix) {
    const rowId = generateTrulyUniqueRowId();
    Object.keys(attributesBySuffix).forEach((attributeName) => {
      newAttributes[`repeating_${section}_${rowId}_${attributeName}`] = attributesBySuffix[attributeName];
    });
  }
  function addNewDiscipline(skillname, props) {
    addNewAttributeRow({
      skilldisciplineinfo: 'D',
      skillname,
      ...props,
    });
  }
  function addNewSkill(skillname, props) {
    addNewAttributeRow({
      skilldisciplineinfo: 'â‡¡',
      skillname,
      ...props,
    });
  }
  function addNewSkillWithNoDiscipline(skillname, props) {
    addNewAttributeRow({
      skilldisciplineinfo: '',
      skillname,
      ...props,
    });
  }
  if (includePersonal) {
    addNewSkillWithNoDiscipline('Language (Common)', { skillattribute: 'IQ', skillexpertise: 'ST', skillBase: 2});
    addNewDiscipline('People');
    addNewSkill('Manners (Common)', { skillattribute: 'IQ', skillexpertise: 'ST', skillBase: 2});
    addNewSkill('Persuade', { skillattribute: 'IQ', skillexpertise: 'ST' });
    addNewSkill('People Insight', { skillattribute: 'IQ', skillexpertise: 'ST', skillBase: 1 });
  }
  addNewDiscipline('Defense', { skillexpertise: 1 });
  addNewSkill('Guard', { skillattribute: 'DX', skillexpertise: 'ST', skillbase: -3 });
  addNewSkill('Resolve', { skillattribute: 'IQ', skillexpertise: 'ST', skillbase: 0 });
  addNewSkill('Robustness', { skillattribute: 'BR', skillexpertise: 'ST', skillbase: 0 });
  addNewDiscipline('Attack', { skillexpertise: 1 });
  addNewSkill('Your Weapon', { skillattribute: 'DX', skillexpertise: '1', skillbase: 0 });
  addNewSkill('Unarmed', { skillattribute: 'BR+DX', skillexpertise: 'ST', skillbase: -1 });
  return newAttributes;
}

on('clicked:addbaseskills', () => {
  setAttrs(createBaseSkillsAttributes(), () => {
    console.log('Added attributes. The sheet auto-calculates after this.');
    closePopovers();
  });
});
// -------------- Equipment -------------

// Update the derived properties: best_weapon_defense and best_weapon_damage.
const updateCopiedWeaponInfo = function () {
  getSectionIDs('weapon', function (ids) {
    const defenseFields = ids.map(
      id => `repeating_weapon_${id}_weapondefense`);
    const damageFields = ids.map(
      id => `repeating_weapon_${id}_weapondamage`);
    const countFields = ids.map(
      id => `repeating_weapon_${id}_weaponcount`);
    getAttrs([...defenseFields, ...damageFields, ...countFields], function (values) {
      let update = {};
      update['best_weapon_defense'] = _.range(ids.length).reduce((memo, i) => {
        const defense = getNumberIfValid(values[defenseFields[i]]);
        const count = getNumberIfValid(values[countFields[i]]);
        if (defense > 0 && count > 0) {
          return Math.max(memo, defense);
        }
        return memo;
      }, 0);
      update['best_weapon_damage'] = _.range(ids.length).reduce((memo, i) => {
        const damage = getNumberPart(values[damageFields[i]]);
        const count = getNumberIfValid(values[countFields[i]]);
        if (damage > 0 && count > 0) {
          return Math.max(memo, damage);
        }
        return memo;
      }, -5);
      console.log('highest weapon defense: ' + update['best_weapon_defense'].toString() +
        ' highest weapon damage: ' + update['best_weapon_damage'].toString());
      setAttrs(update);
    });
  });
}
on('change:repeating_weapon:weaponcount change:repeating_weapon:weapondefense' +
   ' change:repeating_weapon:weapondamage remove:repeating_weapon sheet:opened',
updateCopiedWeaponInfo);

const updateDefenseValues = function () {
  const armorName = 'armor_defense';
  const shieldName = 'shield_defense';
  const defenseBoostName = 'defense_boost';
  const highestWeaponDefenseName = 'best_weapon_defense';
  const guardName = 'guard';
  getAttrs([armorName, shieldName, defenseBoostName, highestWeaponDefenseName,
            guardName],
    function (values) {
      const cur_armor = getNumberIfValid(values[armorName]);
      const cur_shield = getNumberIfValid(values[shieldName]);
      const highestWeaponDefense = getNumberIfValid(values[highestWeaponDefenseName]);
      const update = {};
      const guard_n = getNumberIfValid(values[guardName]);
      for (let defense of ['dodge', 'block', 'parry']) {
        const defenseIsDodge = defense === 'dodge';
        const defenseIsBlock = defense === 'block';
        const defenseIsParry = defense === 'parry';
        const total = (
          guard_n
          + (defenseIsBlock ? cur_shield : 0)
          + (defenseIsParry ? highestWeaponDefense : 0)
          + getNumberIfValid(values[defenseBoostName])
        );
        /**
          * Block is only valid if there is a shield value and Parry is only valid if there is a weapon.
          */
        const blockIsValid = defenseIsBlock && cur_shield;
        const parryIsValid = defenseIsParry && highestWeaponDefense;
        const defenseIsValid = defenseIsDodge || blockIsValid || parryIsValid;
        update[`current_${defense}_without_armor`] = defenseIsValid ? String(total) : '--';
        update[`current_${defense}_with_armor`] = defenseIsValid ? String(total + cur_armor) : '--';
      }
      setAttrs(update);
    });
}
on('change:armor_defense change:shield_defense change:best_weapon_defense' +
   ' change:guard' +
   ' change:defense_boost sheet:opened',
updateDefenseValues);

const updateSpeed = function () {
  const DX = 'DX';
  const fast = 'advantage_fast_count';
  const penalty = 'weight_penalty';
  getAttrs([DX, fast, penalty], function (values) {
    const effective_DX = (Number(values[DX])
      + Number(values[fast]));
    const penalty_n = Number(values[penalty]);
    const DX_reduction = Math.max(0, Math.min(effective_DX,
      Math.floor(-penalty_n / 2)));
    setAttrs({
      'speed':
        Math.max(0, 6 + effective_DX + penalty_n - DX_reduction)
    });
  });
};
on('change:dx change:advantage_fast_count'
  + ' change:weight_penalty sheet:opened',
updateSpeed);

const updateInitiative = function () {
  const IQ = 'IQ';
  const alert = 'advantage_alert_count';
  getAttrs([IQ, alert], function (values) {
    const effective_IQ = (Number(values[IQ])
      + Number(values[alert]));
    setAttrs({ 'initiative': effective_IQ });
  });
};
on('change:iq change:advantage_alert_count'
  + ' sheet:opened',
updateInitiative);

const updateWeightPenalties = function () {
  const weight = 'equipment_total_weight';
  const BR = 'BR';
  const packmule = 'advantage_packmule_count';
  const highlight = function (penalty) {
    return `highlight_weight_penalty_${penalty}`;
  };
  getAttrs([weight, BR, packmule], function (values) {
    const weight_n = getNumberPart(values[weight]);
    const effective_BR = (Number(values[BR])
      + Number(values[packmule]));
    let current_level = 0;
    let update = {};
    for (let level = 1; level <= 6; ++level) {
      const limit = Math.round(((level * level - 1) * 12 / 7 + 8.333)
        * 3 * 2 ** (effective_BR / 3));
      if (weight_n >= limit) { current_level = level; }
      update[`penalty_weight_${level}`] = limit;
      update[highlight(level)] = '0';
    }
    if (current_level !== 0) {
      update[highlight(current_level)] = '1';
    }
    if (current_level === 6) { current_level = 100; }
    update['weight_penalty'] = -current_level;
    update['displayed_weight_penalty'] = (
      current_level === 0 ? ' ' :
        current_level === 100 ? '-âˆž' :
          -current_level);
    setAttrs(update);
  });
};
on('change:equipment_total_weight' +
  ' change:br' +
  ' change:advantage_packmule_count' +
  ' sheet:opened',
updateWeightPenalties);

const updateTotalX = function (x) {
  const armor = `armor_${x}`;
  const shield = `shield_${x}`;
  const weapons = `weapon_total_${x}`;
  const items = `item_total_${x}`;
  getAttrs([armor, shield, weapons, items], function (values) {
    let update = {};
    update[`equipment_total_${x}`] = roundToTwoPlaces(
      getNumberPart(values[armor]) + getNumberPart(values[shield]) +
      getNumberPart(values[weapons]) + getNumberPart(values[items]));
    setAttrs(update);
  });
};

on('change:armor_weight change:shield_weight' +
  ' change:weapon_total_weight change:item_total_weight',
function () { updateTotalX('weight'); });
on('change:armor_value change:shield_value' +
  ' change:weapon_total_value change:item_total_value',
function () { updateTotalX('value'); });

// Add up the total weight for repeating_<section>:<section><X>
// and put it in <section>_total_<X>
const updateTotalRepeatingX = function (section, x) {
  getSectionIDs(section, function (ids) {
    const x_fields = ids.map(
      id => `repeating_${section}_${id}_${section}${x}`);
    const count_fields = ids.map(
      id => `repeating_${section}_${id}_${section}count`);
    getAttrs(x_fields.concat(count_fields), function (values) {
      let total = 0;
      for (let i = 0; i < ids.length; ++i) {
        total += (getNumberPart(values[x_fields[i]])
          * getNumberPart(values[count_fields[i]]));
      }
      let update = {};
      update[`${section}_total_${x}`] = total;
      setAttrs(update);
    });
  });
};

on('change:repeating_weapon:weaponweight' +
  ' change:repeating_weapon:weaponcount' +
  ' remove:repeating_weapon',
function () { updateTotalRepeatingX('weapon', 'weight'); });
on('change:repeating_weapon:weaponvalue' +
  ' change:repeating_weapon:weaponcount' +
  ' remove:repeating_weapon',
function () { updateTotalRepeatingX('weapon', 'value'); });
on('change:repeating_item:itemweight' +
  ' change:repeating_item:itemcount' +
  ' remove:repeating_item',
function () { updateTotalRepeatingX('item', 'weight'); });
on('change:repeating_item:itemvalue' +
  ' change:repeating_item:itemcount' +
  ' remove:repeating_item',
function () { updateTotalRepeatingX('item', 'value'); });

// -------- Spells ----------
['arcane', 'divine', 'innate'].forEach(button => {
  on(`clicked:${button}`, function () {
    setAttrs({ chosenspelltype: button });
  });
});

on('change:repeating_arcane:skilldisciplineinfo' +
  ' change:repeating_arcane:skillexpertise' +
  ' change:repeating_arcane:skillname' + // Fires for new skill.
  ' remove:repeating_arcane' +
  ' change:_reporder:arcane',
function () { updateSkillDisciplineExpertises('arcane'); });

on('change:repeating_arcane:skilldisciplineinfo' +
  ' change:repeating_arcane:skillexpertise' +
  ' change:repeating_arcane:skilldisciplineexpertise' +
  ' change:repeating_arcane:skillattribute' +
  ' change:repeating_arcane:skillbase',
function (event) { updateSkillDerived('arcane', event); });

on('change:IQ change:advantage_mage_count',
  function () { updateAllSkillsDerived('arcane'); });

on('remove:repeating_arcane',
  function () {
    updateTotalFP('arcane', 'skill');
    updateTotalCP('arcane', 'skill');
  });

on('remove:repeating_innate change:repeating_innate:skillCP',
  function () { updateTotalCP('innate', 'skill'); });


log('!!! SCRIPT LOADED !!!');
  // -------- Create New User --------
const OTHER_RACE = 'other';

['human', 'elf', 'dwarf', 'gnome', 'orc', 'minotaur', 'owlin', 'dryad', OTHER_RACE].forEach(function (newUser) {
  on(`clicked:create_user_pick_${newUser}_option`, () => {
    setAttrs({
      selected_user_race_option: newUser,
    });
  });
});

function createBaseAttributes({ section, attributes }) {
  const newAttributes = {};
  const rowId = generateTrulyUniqueRowId();
  Object.keys(attributes).forEach((attributeName) => {
    const attributeValue = attributes[attributeName];
    if (attributeValue !== undefined) {
      newAttributes[`repeating_${section}_${rowId}_${attributeName}`] = attributeValue;
    }
  });
  return newAttributes;
}

function createFeatAttributes({ featName, cpValue }) {
  return createBaseAttributes({
    section: 'feat',
    attributes: {
      featname: featName,
      featCP: cpValue,
    },
  });
}

function createExtraAdvantageAttributes({ name, cpValue }) {
  return createBaseAttributes({
    section: 'extraadvantage',
    attributes: {
      extraadvantagename: name,
      extraadvantageCP: cpValue,
    },
  });
}


function createInnateSpellAttributes(props) {
  const { isSphereAttribute, name, castTime, spellType, range, target, duration, epValue, cpValue } = props;
  return createBaseAttributes({
    section: 'innate',
    attributes: {
      skillinnatesphere: isSphereAttribute ? 'S' : '',
      skillname: name,
      skillEP: epValue,
      spellcasttime: castTime,
      spelltype: spellType,
      spellrange: range,
      spelltarget: target,
      spellduration: duration,
      skillCP: cpValue,
    },
  });
}

const newUserAttributesByRace = {
  human: {},
  elf: {
    ...createFeatAttributes({ featName: 'Low Light Vision', cpValue: 1 }),
    ...createFeatAttributes({ featName: 'Ease of Movement', cpValue: 1 }),
  },
  dwarf: {
    ...createFeatAttributes({ featName: 'Infravision', cpValue: 1 }),
  },
  gnome: {
    ...createFeatAttributes({ featName: 'Infravision', cpValue: 1 }),
  },
  orc: {
    ...createFeatAttributes({ featName: 'Infravision', cpValue: 1 }),
    ...createExtraAdvantageAttributes({ name: 'Not Attractive', cpValue: -1 }),
  },
  minotaur: {
    height: 6.5,
    weight: 200,
    ...createFeatAttributes({ featName: 'Natural Attack', cpValue: 3 }),
  },
  owlin: {
    weight: 100,
    DX: 2,
    ...createFeatAttributes({ featName: 'Low Light Vision', cpValue: 1 }),
    ...createFeatAttributes({ featName: 'Natural Armor', cpValue: 1 }),
    ...createFeatAttributes({ featName: 'Glide', cpValue: 1 }),
  },
  dryad: {
    ...createFeatAttributes({ featName: 'Low Light Vision', cpValue: 1 }),
    ...createFeatAttributes({ featName: 'Natural Armor', cpValue: 3 }),
    ...createExtraAdvantageAttributes({ name: 'Arboreal Connection', cpValue: 0 }),
    ...createExtraAdvantageAttributes({ name: 'Avoid Metal', cpValue: -2 }),
    chosenspelltype: 'innate',
    ...createInnateSpellAttributes({ isSphereAttribute: true, name: 'Nature', cpValue: 2 }),
    ...createInnateSpellAttributes({ name: 'Meld with Tree', target: 'Self', duration: '1 minute', epValue: 2, cpValue: 1 }),
  },
  [OTHER_RACE]: {},
};

on('clicked:confirm_create_new_user', () => {
  getAttrs(['selected_user_race_option'], (values) => {
    const { selected_user_race_option: selectedRace } = values;
    const newUserAttributes = newUserAttributesByRace[selectedRace];
    if (!newUserAttributes) {
      log(`Something went wrong for selectedUserOption: ${selectedRace}`);
      return;
    }
    const racePicked = selectedRace !== OTHER_RACE;
    setAttrs({
      ...createBaseSkillsAttributes(racePicked),
      ...newUserAttributes,
      race: `${selectedRace.charAt(0).toUpperCase()}${selectedRace.slice(1)}`,
      chosentab: 'basic',
    });
  });
});

log('!!! newUser SCRIPT LOADED !!!');

</script>
